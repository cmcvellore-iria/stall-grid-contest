<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CMC Stall Grid Passport – IRIA 2025</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}

    body{
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background:#020617;
      color:#f8fafc;
      overflow-x:hidden;
    }

    /* MOBILE VH FIX */
    :root{ --vh: 1vh; }
    .panel{ min-height:calc(var(--vh)*100); }

    /* CHAPEL BACKDROP */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:url("assets/chapel-hero.jpg") center center/cover no-repeat;
      z-index:-2;
    }
    body::after{
      content:"";
      position:fixed;
      inset:0;
      background:linear-gradient(to bottom, rgba(0,0,0,0.1) 5%, rgba(0,0,0,0.28) 95%);
      z-index:-1;
    }

    /* LOGOS FIXED */
    .logo-row{
      position:fixed;
      top:1rem;
      left:0; right:0;
      display:flex;
      justify-content:space-between;
      padding:0 1.2rem;
      z-index:50;
    }
    .logo-row img{height:64px;}

    /* FIXED HERO TITLE (FADES OUT WHEN SCROLLING) */
    .hero-title-wrap{
      position:fixed;
      top:5.2rem;
      left:50%;
      transform:translateX(-50%);
      text-align:center;
      color:white;
      z-index:40;
      opacity:1;
      transition:opacity .6s ease;
      pointer-events:none;
    }
    .hero-title-faded{ opacity:0; }

    .hero-title-main{font-weight:600;font-size:1.2rem;text-shadow:0 2px 10px #0007}
    .hero-title-sub{font-size:1rem;opacity:.9;margin-top:4px}

    /* PANELS */
    section.panel{
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding:0 1.2rem 22vh;
      opacity:0;
      transform:translateY(30px);
      transition:opacity .9s ease, transform .9s ease;
    }
    section.panel.active{
      opacity:1;
      transform:translateY(0);
    }

    /* HERO GLASS CARDS — START LOW (SLIVER VISIBLE) */
    .hero-area{
      width:100%;
      max-width:900px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:14px;

      transform:translateY(110px);
      opacity:0;
      animation:riseUp 1.6s ease forwards 0.4s;
    }

    @keyframes riseUp{
      0%{ transform:translateY(110px); opacity:0; }
      100%{ transform:translateY(0); opacity:1; }
    }

    .glass{
      background:rgba(255,255,255,0.22);
      backdrop-filter:blur(12px);
      padding:14px 18px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.35);
      width:100%;
      max-width:820px;
      color:#02101c;
      box-shadow:0 18px 50px rgba(0,0,0,0.55);
      transition:opacity .6s ease;
    }

    .verse-block{
      font-family:"Times New Roman",serif;
      font-style:italic;
      font-size:1rem;
      line-height:1.5;
    }
    .verse-ref{
      font-size:.86rem;
      margin-top:6px;
      opacity:.92;
      display:block;
    }

    /* IDA PREVIEW */
    .ida-title{
      font-family:"Times New Roman",serif;
      font-style:italic;
      font-size:.95rem;
    }
    .ida-preview{
      font-family:"Times New Roman",serif;
      font-style:italic;
      font-size:.9rem;
      opacity:.92;
      margin-top:6px;
    }

    /* HERO ACTIONS */
    .hero-actions{
      margin-top:4px;
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:center;
    }
    .link-button{
      padding:8px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.7);
      background:rgba(9,14,21,.32);
      color:white;
      cursor:pointer;
      font-weight:600;
    }

    .scroll-hint{
      font-size:.82rem;
      color:white;
      opacity:.92;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .arrow{ font-size:1.2rem; animation:bounce 1.6s infinite; }
    @keyframes bounce{
      0%,100%{ transform:translateY(0); }
      50%{ transform:translateY(5px); }
    }

    /* CONTEST SECTION */
    .contest-card{
      max-width:820px;
      padding:20px;
      border-radius:14px;
      background:rgba(255,255,255,0.15);
      backdrop-filter:blur(10px);
      border:1px solid rgba(255,255,255,.25);
      color:white;
      text-align:left;
    }
    .pill{
      padding:6px 12px;
      border-radius:999px;
      background:rgba(9,14,21,.75);
      font-size:12px;
      letter-spacing:.14em;
      border:1px solid rgba(255,255,255,.2);
      color:#e1ecff;
      display:inline-block;
    }
    /* --------- remaining CSS (continued) --------- */
    .contest-card h2{font-size:1.28rem;margin:8px 0}
    .contest-card p{line-height:1.6}
    .contest-card ul{margin-left:1rem}

    /* PASSPORT / AUTH / GRID */
    #passport{ align-items:flex-start; padding-top:18vh; }
    .content-wrap{ max-width:1024px; width:98%; margin:0 auto; display:flex; flex-direction:column; gap:16px; }
    .auth-card, .grid-card{ padding:16px; border-radius:12px; background:rgba(255,255,255,0.06); color:#eaf6ff; border:1px solid rgba(255,255,255,0.04); box-shadow:0 14px 40px rgba(0,0,0,0.6); }

    .auth-top{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    #auth-status{ font-size:0.9rem; opacity:0.9; }

    input{ width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background:rgba(3,6,12,0.45); color:#eaf6ff; margin-top:10px; }

    .auth-buttons{ display:flex; gap:10px; margin-top:12px; }
    .btn-register{ background:rgba(154,211,188,0.95); color:#043024; padding:10px 14px; border-radius:999px; border:none; cursor:pointer; }
    .btn-login{ background:rgba(139,188,230,0.95); color:#06253b; padding:10px 14px; border-radius:999px; border:none; cursor:pointer; }
    .btn-refresh{ background:rgba(139,188,230,0.95); color:#06253b; padding:8px 12px; border-radius:999px; border:none; cursor:pointer; }

    .grid-container{ display:grid; grid-template-columns:repeat(auto-fit,minmax(110px,1fr)); gap:10px; margin-top:12px; }
    .neon-stall{ padding:12px; border-radius:12px; background:radial-gradient(circle at top,#071025,#02101a 85%); border:1px solid rgba(34,211,238,0.48); color:#a8f6ff; font-weight:700; text-align:center; cursor:pointer; box-shadow:0 10px 24px rgba(10,40,60,0.55); transition:transform .18s, box-shadow .18s; }
    .neon-stall:hover{ transform:translateY(-4px); box-shadow:0 18px 36px rgba(10,40,60,0.75); }
    .neon-stall.visited{ border-color:rgba(74,222,128,0.95); background:linear-gradient(180deg,#032a16,#011212); color:#ccffd6; box-shadow:0 18px 36px rgba(20,60,40,0.6); }

    /* LEADERBOARD LIST */
    #leader-list{ margin-top:10px; font-size:0.95rem; color:#e8f6ff; max-height:260px; overflow:auto; }
    #leader-list .row{ display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.03); }

    /* QR overlay, prayer modal, toast already minimal earlier; ensure z-index high */
    #qr-overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(2,6,12,0.92); z-index:220; padding:18px; }
    #qr-reader{ width:360px; max-width:96%; height:auto; background:#000; border-radius:12px; overflow:hidden; }
    #prayer-modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(3,6,12,0.6); z-index:230; padding:14px; }
    .prayer-card{ max-width:720px; width:100%; background:rgba(255,255,255,0.16); backdrop-filter:blur(12px); padding:16px; border-radius:12px; color:#02101c; max-height:82vh; overflow:auto; }

    @media(max-width:820px){
      .logo-row img{height:52px}
      .hero-title-wrap{top:4.2rem}
      .hero-area{ animation-duration:1.2s; transform:translateY(80px) }
    }
    @media(max-width:420px){
      .logo-row img{height:44px}
      .hero-title-main{font-size:1rem}
      .verse-block{font-size:0.94rem}
    }
  </style>
</head>
<body>

  <!-- FIXED LOGOS -->
  <div class="logo-row">
    <div><img src="assets/iria2025.png" alt="IRIA 2025"></div>
    <div><img src="assets/cmc.png" alt="CMC"></div>
  </div>

  <!-- FIXED HERO TITLE -->
  <div class="hero-title-wrap" id="hero-title">
    <div class="hero-title-main">Welcome to the 78th Annual TNPY IRIA Conference</div>
    <div class="hero-title-sub">at Christian Medical College, Vellore</div>
  </div>

  <!-- HERO PANEL -->
  <section id="hero" class="panel">
    <div class="hero-area" id="hero-area" aria-hidden="false">
      <!-- Verse glass (separate) -->
      <div class="glass" id="verse-glass" style="transform:translateY(12%); opacity:0;">
        <div class="verse-block">
          “Even as the Son of man came not to be ministered unto, but to minister,
          and to give his life a ransom for many.”
          <span class="verse-ref">Matthew 20:28</span>
        </div>
      </div>

      <!-- Ida preview glass (separate) -->
      <div class="glass" id="ida-glass" style="transform:translateY(12%); opacity:0;">
        <div class="ida-title">Aunt Ida’s Prayer</div>
        <div class="ida-preview">Father, whose life is within me, and whose love is ever about me…</div>
      </div>

      <!-- actions -->
      <div class="hero-actions">
        <button class="link-button" onclick="openPrayerModal()">Read the full prayer</button>
        <div class="scroll-hint" onclick="scrollToContest()">Scroll to start the Stall Grid Contest <span class="arrow">↓</span></div>
      </div>
    </div>
  </section>

  <!-- CONTEST INTRO -->
  <section id="contest" class="panel">
    <div class="contest-card">
      <div class="pill">Stall Grid Contest</div>
      <h2>Explore, Scan & Win at IRIA 2025</h2>
      <p>During the 78<sup>th</sup> Annual TNPY IRIA Conference at CMC Vellore, the Stall Grid Passport turns your visit to the trade area into an interactive challenge. Meet exhibitors, discover technologies and collect ticks by scanning QR codes at each stall.</p>
      <p><strong>How it works:</strong></p>
      <ul>
        <li>Register once with your name, email and a password.</li>
        <li>Login on your phone or tablet using the same email.</li>
        <li>Tap a stall tile and scan the QR code displayed at that exhibitor’s stall.</li>
        <li>Each successful scan marks the stall as visited with a tick.</li>
        <li>Your total visited stalls contribute to the live leaderboard.</li>
      </ul>
    </div>
  </section>

  <!-- PASSPORT / GRID -->
  <section id="passport" class="panel">
    <div class="content-wrap">
      <div class="auth-card" id="auth-card">
        <div class="auth-top">
          <div>
            <div class="pill">Delegate Login</div>
            <div class="auth-title">Access Your Stall Grid Passport</div>
          </div>
          <div style="display:flex;gap:10px;align-items:center;">
            <div id="auth-status">Not signed in</div>
            <div id="logout-btn" class="hidden"><button class="btn-login" onclick="logoutUser()">Logout</button></div>
          </div>
        </div>

        <input id="name-input" placeholder="Name (as registration)">
        <input id="email-input" placeholder="Email (same as registration)">
        <input id="delegate-input" placeholder="Delegate ID (optional)">
        <input id="password-input" type="password" placeholder="Password">

        <div class="auth-buttons">
          <button class="btn-register" onclick="registerUser()">Register</button>
          <button class="btn-login" onclick="loginUser()">Login</button>
        </div>

        <p style="margin-top:8px;font-size:0.9rem;opacity:0.9;">Use the same name and email as your conference registration to be eligible for prizes. Choose a password different from your email password.</p>
      </div>

      <div class="grid-card hidden" id="grid-card">
        <div class="grid-header">
          <div>
            <div class="pill">Stall Grid</div>
            <div style="font-size:0.98rem;font-weight:600;margin-top:6px;">Scan QR at Each Exhibitor</div>
            <p style="font-size:0.88rem;opacity:0.95;margin-top:6px;">Tap a stall tile to open the camera. After scanning, the stall will glow and your visit counts towards the live leaderboard.</p>
          </div>
        </div>

        <div id="user-banner" class="welcome-line hidden" style="margin-top:8px;font-weight:600;"></div>

        <div id="grid" class="grid-container" aria-live="polite"></div>

        <div id="leaderboard" style="margin-top:14px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <div class="pill">Leaderboard</div>
              <div style="font-size:0.95rem;font-weight:600;margin-top:6px;">Most Active Stall Explorers</div>
            </div>
            <button class="btn-refresh" onclick="manualRefreshLeaderboard()">Refresh</button>
          </div>
          <div id="leader-list"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- QR overlay -->
  <div id="qr-overlay" aria-hidden="true">
    <div id="qr-reader"></div>
    <button id="qr-close" onclick="closeScanner()" style="margin-top:12px;padding:8px 12px;border-radius:999px;border:none;background:#0b1726;color:#e7f6ff;">Close</button>
  </div>

  <!-- Prayer modal -->
  <div id="prayer-modal" aria-hidden="true">
    <div class="prayer-card">
      <h3 style="font-family:Times New Roman,serif;font-style:italic">Aunt Ida’s Prayer</h3>
      <p style="font-family:Times New Roman,serif;font-style:italic">Father, whose life is within me,</p>
      <p style="font-family:Times New Roman,serif;font-style:italic">and whose love is ever about me,</p>
      <p style="font-family:Times New Roman,serif;font-style:italic">Grant that Thy life may be maintained in my life today and every day,</p>
      <p style="font-family:Times New Roman,serif;font-style:italic">as with gladness of heart, without haste or confusion of thought,</p>
      <p style="font-family:Times New Roman,serif;font-style:italic">I go about my daily tasks,</p>
      <p style="font-family:Times New Roman,serif;font-style:italic">conscious of the ability to meet every rightful demand,</p>
      <p style="font-family:Times New Roman,serif;font-style:italic">seeing the larger meaning of little things,</p>
      <p style="font-family:Times New Roman,serif;font-style:italic">and finding beauty and love everywhere.</p>
      <p style="font-family:Times New Roman,serif;font-style:italic">In the sense of Thy presence, may I walk through the hours,</p>
      <p style="font-family:Times New Roman,serif;font-style:italic">breathing the atmosphere of love rather than anxious striving...</p>
      <p style="margin-top:8px;font-style:italic">— Dr. Ida S. Scudder</p>
      <div style="text-align:right;margin-top:8px;"><button class="link-button" onclick="closePrayerModal()">Close</button></div>
    </div>
  </div>

  <div id="toast" role="status"></div>

  <!-- html5-qrcode (scanner lib) -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <!-- FIREBASE + APP LOGIC -->
  <script type="module">
    // Mobile VH fix (set early)
    function setRealVH(){
      document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px');
    }
    setRealVH();
    window.addEventListener('resize', setRealVH);
    window.addEventListener('orientationchange', setRealVH);

    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
    import {
      getAuth,
      setPersistence,
      browserLocalPersistence,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      getDocs,
      collection,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

    // ---------- FIREBASE CONFIG (YOUR PROJECT) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyCMQDWuUnVCbfr5Sozj9c2XMkISkc7WB00",
      authDomain: "cmc-stallgrid-passport.firebaseapp.com",
      projectId: "cmc-stallgrid-passport",
      storageBucket: "cmc-stallgrid-passport.appspot.com",
      messagingSenderId: "729984975490",
      appId: "1:729984975490:web:757bca01efebe3149caa9b"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    // persist auth across restarts
    setPersistence(auth, browserLocalPersistence).catch(()=>{ /* ignore */ });
    const db = getFirestore(app);

    // Elements
    const panels = document.querySelectorAll("section.panel");
    const heroArea = document.getElementById("hero-area");
    const verseGlass = document.getElementById("verse-glass");
    const idaGlass = document.getElementById("ida-glass");
    const heroTitle = document.getElementById("hero-title");
    const prayerModal = document.getElementById("prayer-modal");
    const toastEl = document.getElementById("toast");
    const authStatus = document.getElementById("auth-status");
    const authCard = document.getElementById("auth-card");
    const gridCard = document.getElementById("grid-card");
    const userBanner = document.getElementById("user-banner");
    const logoutBtn = document.getElementById("logout-btn");
    const gridEl = document.getElementById("grid");
    const leaderListEl = document.getElementById("leader-list");

    // IntersectionObserver for panels (crossfade)
    const observer = new IntersectionObserver((entries)=>{
      entries.forEach(entry=>{
        if(entry.isIntersecting){
          entry.target.classList.add("active");
          if(entry.target.id === "contest"){
            // fade hero title and hero-area glass out
            heroTitle.classList.add("hero-title-faded");
            verseGlass.style.opacity = "0";
            idaGlass.style.opacity = "0";
            // subtle hide hero-area to allow contest to show
            heroArea.style.opacity = "0";
          }
        } else {
          // when hero returns to view, restore
          if(entry.target.id === "contest" && document.getElementById("hero").getBoundingClientRect().top >= 0){
            heroTitle.classList.remove("hero-title-faded");
            verseGlass.style.opacity = "1";
            idaGlass.style.opacity = "1";
            heroArea.style.opacity = "1";
          }
        }
      });
    },{ threshold: 0.28 });
    panels.forEach(p=>observer.observe(p));

    // animate the two glass cards (they start peeking — small sliver)
    function animateHeroGlassIn(){
      // delay slightly so chapel is visible first
      setTimeout(()=>{
        verseGlass.animate([
          { transform: 'translateY(12%)', opacity: 0 },
          { transform: 'translateY(0)', opacity: 1 }
        ], {
          duration: 1100,
          easing: 'cubic-bezier(.25,.1,.25,1)',
          fill: 'forwards'
        });
        idaGlass.animate([
          { transform: 'translateY(12%)', opacity: 0 },
          { transform: 'translateY(0)', opacity: 1 }
        ], {
          duration: 1100,
          easing: 'cubic-bezier(.25,.1,.25,1)',
          fill: 'forwards',
          delay: 120
        });
      }, 650); // small wait so chapel visually anchors
    }
    animateHeroGlassIn();

    // scroll helpers
    window.scrollToContest = ()=>document.getElementById("contest").scrollIntoView({behavior:"smooth"});
    window.scrollToLeaderboard = ()=>document.getElementById("leaderboard").scrollIntoView({behavior:"smooth", block:"start"});

    // prayer modal
    window.openPrayerModal = ()=>{ prayerModal.style.display='flex'; prayerModal.setAttribute('aria-hidden','false'); };
    window.closePrayerModal = ()=>{ prayerModal.style.display='none'; prayerModal.setAttribute('aria-hidden','true'); };

    // toast
    function showToast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      toastEl.style.opacity = '1';
      setTimeout(()=>{ toastEl.classList.remove('show'); toastEl.style.opacity='0' },2200);
    }

    // AUTH UI wiring
    const nameInput = document.getElementById("name-input");
    const emailInput = document.getElementById("email-input");
    const passInput = document.getElementById("password-input");
    const delegateInput = document.getElementById("delegate-input");

    // register
    async function registerUser(){
      const name = nameInput.value.trim();
      const email = emailInput.value.trim();
      const pass = passInput.value.trim();
      const del = delegateInput.value.trim();
      if(!name || !email || !pass){ alert("Name, email and password required"); return; }
      try{
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        if(name) await updateProfile(cred.user, { displayName: name });
        await setDoc(doc(db,"users",cred.user.uid), { name, email, delegateId: del||null, createdAt: serverTimestamp() }, { merge:true });
        showToast("Registered & signed in");
        document.getElementById("passport").scrollIntoView({behavior:"smooth"});
      }catch(e){
        alert(e.message || String(e));
      }
    }
    window.registerUser = registerUser;

    // login
    async function loginUser(){
      const email = emailInput.value.trim();
      const pass = passInput.value.trim();
      if(!email || !pass){ alert("Enter email & password"); return; }
      try{
        await signInWithEmailAndPassword(auth, email, pass);
        showToast("Logged in");
        document.getElementById("passport").scrollIntoView({behavior:"smooth"});
      }catch(e){
        alert(e.message || String(e));
      }
    }
    window.loginUser = loginUser;

    // logout
    window.logoutUser = async function(){
      try{ await signOut(auth); showToast("Logged out"); }
      catch(e){ console.error(e); }
    };

    // reflect auth state
    onAuthStateChanged(auth, async (user)=>{
      if(user){
        const display = user.displayName || user.email || "Delegate";
        authStatus.textContent = `Signed in as ${display}`;
        authCard.classList.add("hidden");
        gridCard.classList.remove("hidden");
        logoutBtn.classList.remove("hidden");

        // fetch profile
        try{
          const ps = await getDoc(doc(db,"users",user.uid));
          if(ps.exists()){
            const data = ps.data();
            const nm = data.name || display;
            const del = data.delegateId;
            userBanner.textContent = del ? `Welcome, ${nm} (Delegate ID: ${del})` : `Welcome, ${nm}`;
          } else {
            userBanner.textContent = `Welcome, ${display}`;
          }
        }catch(e){
          userBanner.textContent = `Welcome, ${display}`;
        }
        userBanner.classList.remove("hidden");

        await loadUserVisits(user.uid);
        await loadLeaderboard();
      } else {
        authStatus.textContent = "Not signed in";
        authCard.classList.remove("hidden");
        gridCard.classList.add("hidden");
        userBanner.classList.add("hidden");
        logoutBtn.classList.add("hidden");
        clearVisitedStalls();
        leaderListEl.innerHTML = "";
      }
    });

    // STALL GRID — dynamic from Firestore 'stalls' collection when available; fallback to 12
    async function buildGridFromFirestore(){
      gridEl.innerHTML = "";
      try{
        const snap = await getDocs(collection(db,"stalls"));
        if(snap.empty){
          for(let i=1;i<=12;i++) createStallCard({ id:`Stall ${i}`, name:`Stall ${i}` });
          return;
        }
        const stallDocs = [];
        snap.forEach(ds=>{
          const docId = ds.id;
          const data = ds.data() || {};
          const name = data.name || docId;
          stallDocs.push({ id:docId, name });
        });
        stallDocs.sort((a,b)=>a.name.localeCompare(b.name, undefined, { numeric:true }));
        stallDocs.forEach(s=>createStallCard(s));
      }catch(e){
        console.error("Error loading stalls", e);
        for(let i=1;i<=12;i++) createStallCard({ id:`Stall ${i}`, name:`Stall ${i}` });
      }
    }

    function createStallCard(stall){
      const div = document.createElement("div");
      div.className = "neon-stall";
      div.dataset.stallId = stall.name;
      div.innerHTML = `<div style="font-size:0.95rem">${stall.name}</div><div style="font-size:0.78rem;opacity:0.9">Tap to scan</div>`;
      div.addEventListener("click", ()=>openScanner(stall.name));
      gridEl.appendChild(div);
    }

    function clearVisitedStalls(){
      document.querySelectorAll(".neon-stall").forEach(c=>{
        c.classList.remove("visited");
        c.innerHTML = `<div style="font-size:0.95rem">${c.dataset.stallId}</div><div style="font-size:0.78rem;opacity:0.9">Tap to scan</div>`;
      });
    }

    function markStallVisited(stallName){
      document.querySelectorAll(".neon-stall").forEach(card=>{
        if(card.dataset.stallId === stallName){
          card.classList.add("visited");
          card.innerHTML = `<div style="font-size:0.95rem">${stallName} ✓</div><div style="font-size:0.78rem;opacity:0.9">Visited</div>`;
        }
      });
    }

    async function loadUserVisits(uid){
      try{
        const snap = await getDocs(collection(db,"visits",uid,"stalls"));
        snap.forEach(docSnap=>{
          markStallVisited(docSnap.id);
        });
      }catch(e){
        console.error("Error loading visits", e);
      }
    }

    // QR SCANNER via html5-qrcode
    let html5QrInstance = null;
    let currentStallName = null;
    const qrOverlay = document.getElementById("qr-overlay");

    async function openScanner(stallName){
      if(!auth.currentUser){ alert("Please login first to record visits."); return; }
      currentStallName = stallName;
      qrOverlay.style.display = "flex";
      const regionId = "qr-reader";
      if(!html5QrInstance) html5QrInstance = new Html5Qrcode(regionId);

      try{
        await html5QrInstance.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          async (decodedText) => {
            try{ await html5QrInstance.stop(); }catch(_){}
            qrOverlay.style.display = "none";
            await recordVisit(currentStallName, decodedText);
          },
          (err)=>{ /* ignore decode failures */ }
        );
      }catch(err){
        qrOverlay.style.display = "none";
        alert("Camera error: " + (err && err.message ? err.message : err));
      }
    }
    window.openScanner = openScanner;

    async function closeScanner(){
      qrOverlay.style.display = "none";
      if(html5QrInstance){
        try{ await html5QrInstance.stop(); }catch(_){}
      }
    }
    window.closeScanner = closeScanner;

    // record visit
    async function recordVisit(stallName, qrText){
      const user = auth.currentUser;
      if(!user) return;
      const uid = user.uid;
      try{
        await setDoc(doc(db,"visits",uid), { updatedAt: serverTimestamp() }, { merge:true });
        await setDoc(doc(db,"visits",uid,"stalls",stallName), { stall: stallName, scannedText: qrText || null, visitedAt: serverTimestamp() }, { merge:true });
        markStallVisited(stallName);
        showToast(`Recorded visit: ${stallName}`);
        await loadLeaderboard();
      }catch(e){
        console.error("Error recording visit", e);
        alert("Could not record visit. Try again.");
      }
    }

    // LEADERBOARD (Firestore native)
    async function loadLeaderboard(){
      leaderListEl.innerHTML = '<div style="padding:8px 0;color:rgba(240,248,255,0.9)">Loading…</div>';
      try{
        const visitUsersSnap = await getDocs(collection(db,"visits"));
        const rows = [];
        for(const userDoc of visitUsersSnap.docs){
          const uid = userDoc.id;
          const stallsSnap = await getDocs(collection(db,"visits",uid,"stalls"));
          const count = stallsSnap.size;
          if(count === 0) continue;
          let displayName = uid.substring(0,6);
          try{
            const userProfile = await getDoc(doc(db,"users",uid));
            if(userProfile.exists()){
              const data = userProfile.data();
              displayName = data.name || data.delegateId || data.email || displayName;
            }
          }catch(_){}
          rows.push({ uid, displayName, count });
        }
        rows.sort((a,b)=>b.count - a.count);
        if(rows.length === 0){
          leaderListEl.innerHTML = '<div style="padding:8px 0;color:rgba(240,248,255,0.7)">No visits recorded yet.</div>';
          return;
        }
        leaderListEl.innerHTML = '';
        rows.forEach((r,i)=>{
          const row = document.createElement('div');
          row.className = 'row';
          row.innerHTML = `<div style="font-weight:700">${i+1}. ${r.displayName}</div><div style="opacity:0.9">${r.count} stall${r.count===1?"":"s"}</div>`;
          leaderListEl.appendChild(row);
        });
      }catch(e){
        console.error("Error loading leaderboard", e);
        leaderListEl.innerHTML = '<div style="padding:8px 0;color:#ffdddd">Error loading leaderboard.</div>';
      }
    }
    window.manualRefreshLeaderboard = function(){ loadLeaderboard().then(()=>showToast("Leaderboard refreshed")); };

    // initial build
    await buildGridFromFirestore();

    // periodic refresh
    setInterval(()=>{ if(document.visibilityState==='visible') loadLeaderboard(); }, 15000);

  </script>
</body>
</html>
