<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CMC Stall Grid Passport – IRIA 2025</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!--
    EXPECTED FILES IN ./assets
    --------------------------------
    chapel-hero.jpg     (natural chapel + pond hero image)
    cmc.png             (CMC logo)
    iria2025.png        (IRIA 2025 logo)
  -->

  <style>
    *{margin:0;padding:0;box-sizing:border-box}

    html,body{
      height:100%;
      font-family:"Segoe UI",system-ui,-apple-system,sans-serif;
      scroll-behavior:smooth;
      background:#020617;
      color:#f9fafb;
    }

    body{
      overflow-x:hidden;
      position:relative;
    }

    /* GLOBAL CHAPEL BACKGROUND (slightly lighter, fixed) */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:url("assets/chapel-hero.jpg") center center / cover no-repeat;
      z-index:-2;
    }
    body::after{
      content:"";
      position:fixed;
      inset:0;
      /* a bit less dark than before (lighter by ~5–7%) */
      background:linear-gradient(
        to bottom,
        rgba(0,0,0,0.04) 5%,
        rgba(0,0,0,0.22) 90%
      );
      z-index:-1;
    }

    /* GENERIC SECTION PANEL */
    section.panel{
      position:relative;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0 1.4rem 16vh;
      text-align:center;
      color:#f9fafb;
      overflow:hidden;
      opacity:0;
      transform:translateY(32px);
      transition:opacity 0.9s ease-out, transform 0.9s ease-out;
    }
    section.panel.active{
      opacity:1;
      transform:translateY(0);
    }

    /* HERO */
    #hero{
      align-items:flex-end;
      padding-bottom:18vh;
    }

    .logo-row{
      position:absolute;
      top:1.1rem;
      left:0;
      right:0;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:0 1.4rem;
      z-index:2;
    }
    .logo-row img{
      height:74px; /* bigger & clear */
      filter:drop-shadow(0 0 6px rgba(0,0,0,0.7));
    }

    .hero-title-wrap{
      position:absolute;
      top:4.8rem;
      left:50%;
      transform:translateX(-50%);
      text-align:center;
      z-index:2;
      opacity:0;
      transform-origin:center;
      animation:heroTitleFade 1.4s cubic-bezier(.25,.1,.25,1) 0.3s forwards;
    }
    .hero-title-main{
      font-size:1.15rem;
      font-weight:600;
      text-shadow:0 2px 6px rgba(0,0,0,0.8);
    }
    .hero-title-sub{
      margin-top:0.2rem;
      font-size:0.9rem;
      opacity:0.9;
      text-shadow:0 2px 6px rgba(0,0,0,0.8);
    }

    @keyframes heroTitleFade{
      0%{opacity:0;transform:translate(-50%,10px);}
      100%{opacity:1;transform:translate(-50%,0);}
    }

    .hero-lower{
      max-width:80%;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:0.6rem;
      opacity:0;
      transform:translateY(20px);
      animation:heroLowerFade 1.7s cubic-bezier(.25,.1,.25,1) 0.75s forwards;
      transition:opacity 0.6s ease, transform 0.6s ease, filter 0.6s ease;
    }
    .hero-lower.fade-out{
      opacity:0;
      transform:translateY(-12px);
      filter:blur(3px);
    }

    @keyframes heroLowerFade{
      0%{opacity:0;transform:translateY(20px);}
      100%{opacity:1;transform:translateY(0);}
    }

    .hero-glass{
      padding:0.9rem 1.4rem;
      background:rgba(255,255,255,0.22);
      backdrop-filter:blur(10px);
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.35);
      text-align:center;
      color:#020617;
      box-shadow:0 16px 50px rgba(0,0,0,0.6);
    }

    .verse-block{
      font-family:"Times New Roman",serif;
      font-style:italic;
      font-size:0.96rem;
      line-height:1.5;
    }
    .verse-ref{
      margin-top:0.25rem;
      font-size:0.86rem;
      opacity:0.9;
    }

    .ida-preview-title{
      margin-top:0.55rem;
      font-family:"Times New Roman",serif;
      font-style:italic;
      font-size:0.9rem;
    }
    .ida-preview-line{
      margin-top:0.3rem;
      font-family:"Times New Roman",serif;
      font-style:italic;
      font-size:0.9rem;
    }

    .hero-actions{
      margin-top:0.55rem;
      display:flex;
      flex-direction:column;
      gap:0.35rem;
      align-items:center;
    }

    .link-button{
      font-size:0.8rem;
      padding:0.32rem 0.9rem;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.7);
      background:rgba(15,23,42,0.4);
      backdrop-filter:blur(8px);
      color:#e5e7eb;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:0.25rem;
      transition:background 0.2s ease, transform 0.18s ease, box-shadow 0.18s ease, opacity 0.2s ease;
    }
    .link-button:hover{
      background:rgba(15,23,42,0.7);
      box-shadow:0 8px 20px rgba(0,0,0,0.7);
      transform:translateY(-1px);
    }

    .scroll-to-contest{
      margin-top:0.4rem;
      font-size:0.78rem;
      letter-spacing:0.18em;
      text-transform:uppercase;
      opacity:0.95;
      text-shadow:0 1px 3px rgba(0,0,0,0.7);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:0.3rem;
      transition:opacity 0.2s ease, transform 0.2s ease;
    }
    .scroll-to-contest span.arrow{
      font-size:1.2rem;
      animation:bounceArrow 1.7s ease-in-out infinite;
    }
    .scroll-to-contest:hover{
      opacity:1;
      transform:translateY(-1px);
    }

    @keyframes bounceArrow{
      0%,100%{transform:translateY(0);}
      50%{transform:translateY(3px);}
    }

    @media(max-width:720px){
      #hero{
        padding:0 1rem 14vh;
      }
      .logo-row{
        padding:0 0.9rem;
      }
      .logo-row img{
        height:60px;
      }
      .hero-title-main{
        font-size:1rem;
      }
      .hero-title-sub{
        font-size:0.85rem;
      }
      .hero-lower{
        max-width:94%;
      }
      .hero-glass{
        padding:0.85rem 1.1rem;
      }
    }

    /* CONTEST INTRO */
    #contest .contest-card{
      max-width:780px;
      width:100%;
      padding:1.1rem 1.3rem 1rem;
      background:rgba(255,255,255,0.16);
      backdrop-filter:blur(12px);
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.3);
      box-shadow:0 18px 55px rgba(0,0,0,0.85);
      text-align:left;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:0.22rem 0.7rem;
      border-radius:999px;
      font-size:0.72rem;
      letter-spacing:0.18em;
      text-transform:uppercase;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.85);
      color:#e5e7eb;
      margin-bottom:0.35rem;
    }
    #contest h2{
      font-size:1.35rem;
      margin-bottom:0.3rem;
      text-shadow:0 2px 6px rgba(0,0,0,0.8);
    }
    #contest p{
      font-size:0.94rem;
      line-height:1.7;
      margin-bottom:0.35rem;
    }
    #contest ul{
      margin-top:0.35rem;
      padding-left:1.1rem;
      font-size:0.9rem;
      line-height:1.6;
    }

    /* PASSPORT / AUTH / GRID */
    #passport{
      align-items:flex-start;
      padding-top:18vh;
    }

    #passport .content-wrap{
      max-width:980px;
      width:100%;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:1.4rem;
    }

    .auth-card,
    .grid-card{
      background:rgba(255,255,255,0.16);
      backdrop-filter:blur(12px);
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.3);
      box-shadow:0 18px 55px rgba(0,0,0,0.85);
      text-align:left;
      padding:1.1rem 1.15rem 1rem;
    }

    .auth-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:0.5rem;
      margin-bottom:0.55rem;
    }
    .auth-title{
      font-size:1.02rem;
      font-weight:600;
      text-shadow:0 2px 6px rgba(0,0,0,0.7);
    }
    #auth-status{
      font-size:0.8rem;
      opacity:0.85;
    }

    input{
      width:100%;
      padding:0.6rem 0.8rem;
      border-radius:10px;
      border:1px solid rgba(148,163,184,0.72);
      background:rgba(15,23,42,0.9);
      color:#f9fafb;
      margin-top:0.35rem;
      font-size:0.9rem;
    }
    input::placeholder{
      color:rgba(209,213,219,0.78);
    }

    .auth-buttons{
      display:flex;
      gap:0.5rem;
      margin-top:0.6rem;
    }

    button{
      border:none;
      border-radius:999px;
      padding:0.7rem 1.5rem;
      font-size:0.9rem;
      cursor:pointer;
      font-weight:600;
      box-shadow:0 10px 30px rgba(15,23,42,0.85);
      transition:background 0.2s ease, transform 0.18s ease, box-shadow 0.18s ease, opacity 0.18s ease;
      white-space:nowrap;
    }
    button:hover{
      transform:translateY(-1px);
      box-shadow:0 14px 36px rgba(15,23,42,0.95);
      opacity:0.95;
    }
    button:disabled{
      box-shadow:none;
      cursor:not-allowed;
      opacity:0.8;
    }

    /* pastel buttons */
    .btn-register{
      background:rgba(154,211,188,0.9); /* mint */
      color:#043024;
    }
    .btn-login{
      background:rgba(139,188,230,0.9); /* pastel blue */
      color:#06253b;
    }
    .btn-refresh{
      background:rgba(139,188,230,0.9);
      color:#06253b;
      padding:0.35rem 0.9rem;
      font-size:0.78rem;
      box-shadow:0 8px 20px rgba(15,23,42,0.8);
    }

    .hint{
      margin-top:0.6rem;
      font-size:0.8rem;
      opacity:0.9;
    }

    .grid-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:0.5rem;
      margin-bottom:0.3rem;
    }

    .welcome-line{
      font-size:0.9rem;
      margin-bottom:0.25rem;
      font-weight:500;
    }
    .welcome-line span{
      opacity:0.9;
    }

    .grid-container{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(96px,1fr));
      gap:0.55rem;
      margin-top:0.4rem;
    }

    .neon-stall{
      padding:0.7rem 0.4rem;
      border-radius:14px;
      background:radial-gradient(circle at top,#0f172a,#020617 80%);
      border:1px solid rgba(34,211,238,0.55);
      color:#a5f3fc;
      font-size:0.8rem;
      text-align:center;
      cursor:pointer;
      box-shadow:0 0 14px rgba(34,211,238,0.7);
      transition:transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease, background 0.18s ease;
    }
    .neon-stall:hover{
      transform:translateY(-2px);
      box-shadow:0 0 18px rgba(34,211,238,0.95);
      border-color:rgba(34,211,238,0.9);
    }
    .neon-stall.visited{
      border-color:rgba(74,222,128,0.9);
      box-shadow:0 0 18px rgba(74,222,128,0.85);
      color:#bbf7d0;
      background:radial-gradient(circle at top,#022c22,#020617 80%);
    }

    .leader-header{
      margin-top:0.7rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:0.4rem;
    }

    #leader-list{
      list-style:none;
      margin-top:0.4rem;
      text-align:left;
      font-size:0.82rem;
      max-height:220px;
      overflow:auto;
      padding-right:0.3rem;
    }
    #leader-list li{
      padding:0.22rem 0;
      border-bottom:1px solid rgba(30,64,175,0.55);
      display:flex;
      justify-content:space-between;
      gap:0.5rem;
    }
    #leader-list li span.name{
      font-weight:500;
      opacity:0.94;
    }
    #leader-list li span.count{
      font-family:system-ui,monospace;
      opacity:0.85;
    }

    .scroll-to-leader{
      margin-top:0.6rem;
      font-size:0.78rem;
      letter-spacing:0.18em;
      text-transform:uppercase;
      opacity:0.95;
      text-align:center;
      cursor:pointer;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:0.3rem;
      transition:opacity 0.2s ease, transform 0.2s ease;
    }
    .scroll-to-leader span.arrow{
      font-size:1.1rem;
    }
    .scroll-to-leader:hover{
      opacity:1;
      transform:translateY(-1px);
    }

    @media(min-width:900px){
      #passport .content-wrap{
        flex-direction:row;
        align-items:flex-start;
      }
      .auth-card,.grid-card{
        flex:1;
      }
    }

    @media(max-width:720px){
      section.panel{
        padding:0 1rem 14vh;
      }
    }

    /* HIDE/SHOW helpers */
    .hidden{
      display:none !important;
    }

    /* QR OVERLAY */
    #qr-overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.94);
      display:none;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      z-index:50;
      padding:1.2rem;
    }
    #qr-reader{
      width:320px;
      max-width:100%;
      border-radius:16px;
      overflow:hidden;
      background:#020617;
    }
    #qr-close{
      margin-top:0.75rem;
      padding:0.45rem 1.2rem;
      font-size:0.82rem;
      background:#111827;
      color:#e5e7eb;
      box-shadow:none;
    }

    /* PRAYER MODAL */
    #prayer-modal{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.82);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:60;
      padding:1rem;
    }
    .prayer-card{
      max-width:640px;
      width:100%;
      max-height:80vh;
      overflow:auto;
      background:rgba(255,255,255,0.16);
      backdrop-filter:blur(14px);
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.35);
      padding:1rem 1.2rem 1rem;
      color:#020617;
      box-shadow:0 24px 60px rgba(0,0,0,0.95);
    }
    .prayer-card h3{
      font-family:"Times New Roman",serif;
      font-style:italic;
      font-size:1.1rem;
      margin-bottom:0.4rem;
    }
    .prayer-card p{
      font-family:"Times New Roman",serif;
      font-style:italic;
      font-size:0.95rem;
      line-height:1.6;
      margin-bottom:0.35rem;
    }
    .prayer-close{
      margin-top:0.4rem;
      text-align:right;
    }
    .btn-prayer-close{
      background:rgba(15,23,42,0.9);
      color:#e5e7eb;
      padding:0.4rem 0.9rem;
      font-size:0.8rem;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.6);
      box-shadow:0 8px 24px rgba(0,0,0,0.8);
    }

    /* TOAST */
    #toast{
      position:fixed;
      left:50%;
      bottom:26px;
      transform:translateX(-50%) translateY(14px);
      background:#020617;
      color:#e5e7eb;
      padding:0.55rem 1.1rem;
      border-radius:999px;
      font-size:0.8rem;
      box-shadow:0 12px 30px rgba(0,0,0,0.9);
      opacity:0;
      pointer-events:none;
      transition:opacity 0.28s ease, transform 0.28s ease;
      z-index:70;
    }
    #toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(0);
    }
  </style>

  <!-- QR scanner library -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>

<!-- HERO -->
<section id="hero" class="panel">
  <div class="logo-row">
    <img src="assets/iria2025.png" alt="IRIA 2025 Logo">
    <img src="assets/cmc.png" alt="CMC Logo">
  </div>

  <div class="hero-title-wrap">
    <div class="hero-title-main">
      Welcome to the 78th Annual TNPY IRIA Conference
    </div>
    <div class="hero-title-sub">
      at Christian Medical College, Vellore
    </div>
  </div>

  <div class="hero-lower">
    <div class="hero-glass">
      <div class="verse-block">
        “Even as the Son of man came not to be ministered unto, but to minister,
        and to give his life a ransom for many.”
        <div class="verse-ref">Matthew 20:28</div>
      </div>

      <div class="ida-preview-title">
        Aunt Ida’s Prayer
      </div>
      <div class="ida-preview-line">
        Father, whose life is within me, and whose love is ever about me…
      </div>

      <div class="hero-actions">
        <button class="link-button" type="button" onclick="openPrayerModal()">
          Read the full prayer
        </button>
        <div class="scroll-to-contest" onclick="scrollToContest()">
          Scroll to start the Stall Grid Contest
          <span class="arrow">↓</span>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- CONTEST INTRO -->
<section id="contest" class="panel">
  <div class="contest-card">
    <div class="pill">Stall Grid Contest</div>
    <h2>Explore, Scan & Win at IRIA 2025</h2>
    <p>
      During the 78<sup>th</sup> Annual TNPY IRIA Conference at CMC Vellore,
      the Stall Grid Passport turns your visit to the trade area into an interactive
      challenge. Meet exhibitors, discover new technologies and collect digital ticks
      by scanning QR codes at each stall.
    </p>
    <p>
      Each scanned stall adds to your tally and moves you up the live leaderboard.
      Top explorers stand a chance to win exciting prizes announced during the conference.
    </p>

    <p><strong>How it works:</strong></p>
    <ul>
      <li>Register once with your name, email and a password.</li>
      <li>Login on your phone or tablet using the same email.</li>
      <li>Tap a stall tile and scan the QR code displayed at that exhibitor’s stall.</li>
      <li>Each successful scan marks the stall as visited with a tick.</li>
      <li>Your total visited stalls contribute to the live leaderboard.</li>
    </ul>
  </div>
</section>

<!-- PASSPORT / QR / LEADERBOARD -->
<section id="passport" class="panel">
  <div class="content-wrap">

    <!-- Auth -->
    <div class="auth-card" id="auth-card">
      <div class="auth-top">
        <div>
          <div class="pill">Delegate Login</div>
          <div class="auth-title">Access Your Stall Grid Passport</div>
        </div>
        <div id="auth-status">Not signed in</div>
      </div>

      <input id="name-input" placeholder="Name (as registration)">
      <input id="email-input" placeholder="Email (same as registration)">
      <input id="delegate-input" placeholder="Delegate ID (optional)">
      <input id="password-input" type="password" placeholder="Password">

      <div class="auth-buttons">
        <button class="btn-register" style="flex:1" onclick="registerUser()">Register</button>
        <button class="btn-login" style="flex:1" onclick="loginUser()">Login</button>
      </div>

      <p class="hint">
        Use the same name and email as your conference registration to be eligible for prizes.
        Please choose a password different from the one used for your email account.
      </p>
    </div>

    <!-- Grid + leaderboard -->
    <div class="grid-card hidden" id="grid-card">
      <div class="grid-header">
        <div>
          <div class="pill">Stall Grid</div>
          <div style="font-size:0.98rem;font-weight:600;margin-top:0.15rem;">
            Scan QR at Each Exhibitor
          </div>
          <p style="font-size:0.8rem;opacity:0.9;margin-top:0.2rem;">
            Tap a stall tile to open the camera. After scanning, the stall will glow
            and your visit counts towards the live leaderboard.
          </p>
        </div>
      </div>

      <div id="user-banner" class="welcome-line hidden"></div>

      <div id="grid" class="grid-container"></div>

      <div id="leaderboard">
        <div class="leader-header">
          <div>
            <div class="pill">Leaderboard</div>
            <div style="font-size:0.95rem;font-weight:600;margin-top:0.15rem;">
              Most Active Stall Explorers
            </div>
          </div>
          <button class="btn-refresh" type="button" onclick="manualRefreshLeaderboard()">
            Refresh
          </button>
        </div>
        <ul id="leader-list"></ul>
      </div>

      <div class="scroll-to-leader" onclick="scrollToLeaderboard()">
        Scroll down for leaderboard
        <span class="arrow">↓</span>
      </div>
    </div>

  </div>
</section>

<!-- QR overlay -->
<div id="qr-overlay">
  <div id="qr-reader"></div>
  <button id="qr-close" type="button" onclick="closeScanner()">Close</button>
</div>

<!-- Prayer modal -->
<div id="prayer-modal">
  <div class="prayer-card">
    <h3>Aunt Ida’s Prayer</h3>
    <p>Father, whose life is within me,</p>
    <p>and whose love is ever about me,</p>
    <p>Grant that Thy life may be maintained in my life today and every day,</p>
    <p>as with gladness of heart, without haste or confusion of thought,</p>
    <p>I go about my daily tasks,</p>
    <p>conscious of the ability to meet every rightful demand,</p>
    <p>seeing the larger meaning of little things,</p>
    <p>and finding beauty and love everywhere.</p>
    <p>In the sense of Thy presence, may I walk through the hours,</p>
    <p>breathing the atmosphere of love rather than anxious striving...</p>
    <p style="margin-top:0.5rem;">— Dr. Ida S. Scudder</p>

    <div class="prayer-close">
      <button class="btn-prayer-close" type="button" onclick="closePrayerModal()">Close</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<!-- Firebase + app logic -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    onAuthStateChanged,
    updateProfile
  } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    setDoc,
    getDoc,
    getDocs,
    collection,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

  /* ---------- FIREBASE CONFIG (YOUR PROJECT) ---------- */
  const firebaseConfig = {
    apiKey: "AIzaSyCMQDWuUnVCbfr5Sozj9c2XMkISkc7WB00",
    authDomain: "cmc-stallgrid-passport.firebaseapp.com",
    projectId: "cmc-stallgrid-passport",
    storageBucket: "cmc-stallgrid-passport.appspot.com",
    messagingSenderId: "729984975490",
    appId: "1:729984975490:web:757bca01efebe3149caa9b"
  };

  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  /* ---------- SECTION FADE-IN + HERO LOWER FADE-OUT ---------- */
  const panels = document.querySelectorAll("section.panel");
  const heroLower = document.querySelector(".hero-lower");

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if(entry.isIntersecting){
        entry.target.classList.add("active");
        if(entry.target.id === "contest"){
          heroLower.classList.add("fade-out");
        }
      }
    });
  }, { threshold: 0.3 });
  panels.forEach(p => observer.observe(p));

  /* ---------- SCROLL HELPERS ---------- */
  window.scrollToContest = function(){
    document.getElementById("contest").scrollIntoView({ behavior:"smooth" });
  };

  window.scrollToLeaderboard = function(){
    document.getElementById("leaderboard").scrollIntoView({ behavior:"smooth", block:"start" });
  };

  /* ---------- PRAYER MODAL ---------- */
  const prayerModal = document.getElementById("prayer-modal");
  window.openPrayerModal = function(){
    prayerModal.style.display = "flex";
  };
  window.closePrayerModal = function(){
    prayerModal.style.display = "none";
  };

  /* ---------- TOAST ---------- */
  const toastEl = document.getElementById("toast");
  function showToast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(()=>toastEl.classList.remove("show"), 2200);
  }

  /* ---------- AUTH ---------- */
  const nameInput     = document.getElementById("name-input");
  const emailInput    = document.getElementById("email-input");
  const passInput     = document.getElementById("password-input");
  const delegateInput = document.getElementById("delegate-input");
  const authStatus    = document.getElementById("auth-status");
  const authCard      = document.getElementById("auth-card");
  const gridCard      = document.getElementById("grid-card");
  const userBanner    = document.getElementById("user-banner");

  window.registerUser = async function(){
    const email = emailInput.value.trim();
    const pass  = passInput.value.trim();
    const name  = nameInput.value.trim();
    const delId = delegateInput.value.trim();

    if(!email || !pass || !name){
      alert("Name, email and password are required.");
      return;
    }

    try{
      const cred = await createUserWithEmailAndPassword(auth,email,pass);
      if(name){
        await updateProfile(cred.user,{ displayName:name });
      }
      await setDoc(doc(db,"users",cred.user.uid),{
        name: name || null,
        email,
        delegateId: delId || null,
        createdAt: serverTimestamp()
      },{ merge:true });

      showToast("Registered & signed in");
      // scroll to passport/stalls
      document.getElementById("passport").scrollIntoView({ behavior:"smooth" });
    }catch(e){
      alert(e.message);
    }
  };

  window.loginUser = async function(){
    const email = emailInput.value.trim();
    const pass  = passInput.value.trim();
    if(!email || !pass){
      alert("Enter email and password.");
      return;
    }
    try{
      await signInWithEmailAndPassword(auth,email,pass);
      showToast("Logged in");
      document.getElementById("passport").scrollIntoView({ behavior:"smooth" });
    }catch(e){
      alert(e.message);
    }
  };

  onAuthStateChanged(auth, async (user)=>{
    if(user){
      const display = user.displayName || user.email || "Delegate";
      authStatus.textContent = `Signed in as ${display}`;

      // show grid, hide auth
      authCard.classList.add("hidden");
      gridCard.classList.remove("hidden");

      // fetch user profile for banner
      try{
        const profileSnap = await getDoc(doc(db,"users",user.uid));
        let delIdText = "";
        if(profileSnap.exists()){
          const data = profileSnap.data();
          const nm = data.name || display;
          const delId = data.delegateId;
          if(delId){
            userBanner.textContent = `Welcome, ${nm} (Delegate ID: ${delId})`;
          }else{
            userBanner.textContent = `Welcome, ${nm}`;
          }
        }else{
          userBanner.textContent = `Welcome, ${display}`;
        }
        userBanner.classList.remove("hidden");
      }catch(_){
        userBanner.textContent = `Welcome, ${display}`;
        userBanner.classList.remove("hidden");
      }

      await loadUserVisits(user.uid);
      await loadLeaderboard();
    }else{
      authStatus.textContent = "Not signed in";
      authCard.classList.remove("hidden");
      gridCard.classList.add("hidden");
      userBanner.classList.add("hidden");
      clearVisitedStalls();
      document.getElementById("leader-list").innerHTML = "";
    }
  });

  /* ---------- STALL GRID ---------- */
  const gridEl = document.getElementById("grid");
  const stallIds = [];
  const TOTAL_STALLS = 15; // can increase later, grid is dynamic

  for(let i=1; i<=TOTAL_STALLS; i++){
    const id = "Stall " + i;
    stallIds.push(id);
    const div = document.createElement("div");
    div.className = "neon-stall";
    div.dataset.stallId = id;
    div.textContent = id;
    div.addEventListener("click", ()=>openScanner(id));
    gridEl.appendChild(div);
  }

  function clearVisitedStalls(){
    document.querySelectorAll(".neon-stall").forEach(card=>{
      card.classList.remove("visited");
      card.textContent = card.dataset.stallId;
    });
  }

  function markStallVisited(stallName){
    const cards = document.querySelectorAll(".neon-stall");
    cards.forEach(card=>{
      if(card.dataset.stallId === stallName){
        card.classList.add("visited");
        card.textContent = stallName + " ✓";
      }
    });
  }

  async function loadUserVisits(uid){
    try{
      const snap = await getDocs(collection(db,"visits",uid,"stalls"));
      snap.forEach(docSnap=>{
        markStallVisited(docSnap.id);
      });
    }catch(e){
      console.error("Error loading visits",e);
    }
  }

  /* ---------- QR SCANNER ---------- */
  let html5QrInstance = null;
  let currentStallName = null;
  const overlayEl = document.getElementById("qr-overlay");

  window.openScanner = async function(stallName){
    if(!auth.currentUser){
      alert("Please login first to record visits.");
      return;
    }
    currentStallName = stallName;
    overlayEl.style.display = "flex";

    const regionId = "qr-reader";

    if(!html5QrInstance){
      html5QrInstance = new Html5Qrcode(regionId);
    }

    try{
      await html5QrInstance.stop();
    }catch(_){}

    try{
      await html5QrInstance.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        async (decodedText) => {
          try{
            await html5QrInstance.stop();
          }catch(_){}
          overlayEl.style.display = "none";
          await recordVisit(currentStallName, decodedText);
        },
        (_err) => {
          // ignore scan failures
        }
      );
    }catch(err){
      overlayEl.style.display = "none";
      alert("Camera error: " + err);
    }
  };

  window.closeScanner = async function(){
    overlayEl.style.display = "none";
    if(html5QrInstance){
      try{
        await html5QrInstance.stop();
      }catch(_){}
    }
  };

  /* ---------- VISIT RECORDING ---------- */
  async function recordVisit(stallName, qrText){
    const user = auth.currentUser;
    if(!user) return;
    const uid = user.uid;

    try{
      // ensure a top-level doc exists in "visits"
      await setDoc(
        doc(db,"visits",uid),
        { updatedAt: serverTimestamp() },
        { merge:true }
      );

      // store stall visit
      await setDoc(
        doc(db,"visits",uid,"stalls",stallName),
        {
          stall: stallName,
          scannedText: qrText || null,
          visitedAt: serverTimestamp()
        },
        { merge:true }
      );

      markStallVisited(stallName);
      showToast(`Recorded visit: ${stallName}`);
      await loadLeaderboard();
    }catch(e){
      console.error("Error recording visit",e);
      alert("Could not record visit. Please try again.");
    }
  }

  /* ---------- LEADERBOARD ---------- */
  async function loadLeaderboard(){
    const ul = document.getElementById("leader-list");
    ul.innerHTML = "<li><span class='name'>Loading…</span></li>";

    try{
      const visitUsersSnap = await getDocs(collection(db,"visits"));
      const rows = [];

      for(const userDoc of visitUsersSnap.docs){
        const uid = userDoc.id;
        const stallsSnap = await getDocs(collection(db,"visits",uid,"stalls"));
        const count = stallsSnap.size;
        if(count === 0) continue;

        let displayName = "Delegate";
        try{
          const userProfile = await getDoc(doc(db,"users",uid));
          if(userProfile.exists()){
            const data = userProfile.data();
            displayName = data.name || data.delegateId || data.email || "Delegate";
          }
        }catch(_){}

        rows.push({ uid, displayName, count });
      }

      rows.sort((a,b)=>b.count - a.count);

      if(rows.length === 0){
        ul.innerHTML = "<li><span class='name'>No visits recorded yet.</span></li>";
        return;
      }

      ul.innerHTML = "";
      rows.forEach((row,index)=>{
        const li = document.createElement("li");
        const rank = index+1;
        const nameSpan = document.createElement("span");
        nameSpan.className = "name";
        nameSpan.textContent = `${rank}. ${row.displayName}`;
        const countSpan = document.createElement("span");
        countSpan.className = "count";
        countSpan.textContent = `${row.count} stall${row.count===1?"":"s"}`;
        li.appendChild(nameSpan);
        li.appendChild(countSpan);
        ul.appendChild(li);
      });
    }catch(e){
      console.error("Error loading leaderboard",e);
      ul.innerHTML = "<li><span class='name'>Error loading leaderboard.</span></li>";
    }
  }

  window.manualRefreshLeaderboard = function(){
    loadLeaderboard().then(()=>showToast("Leaderboard refreshed"));
  };
  async function loadLeaderboard(){
  const ul=document.getElementById("leader-list");
  ul.innerHTML="Loading…";
  
  const users=await getDocs(collection(db,"users"));
  const list=[];

  for(const u of users.docs){
    const uid=u.id;
    const stalls=await getDocs(collection(db,"visits",uid,"stalls"));
    const count=stalls.size;
    if(count>0) list.push({name:u.data().name||uid,count});
  }
  
  list.sort((a,b)=>b.count-a.count);
  ul.innerHTML=list.map((p,i)=>`${i+1}. ${p.name} — ${p.count}`).join("<br>");
}

</script>

</body>
</html>

