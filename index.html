<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CMC Stall Grid Passport – IRIA 2025</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- EXPECTED ASSETS in ./assets:
       - chapel-hero.jpg
       - cmc.png
       - iria2025.png
  -->

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      color:#f8fafc;
      background:#020617;
      overflow-x:hidden;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Hero background (chapel) */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background: url("assets/chapel-hero.jpg") center center / cover no-repeat;
      z-index:-2;
      background-attachment: fixed;
    }
    /* Slight overlay to make text readable (kept subtle as requested) */
    body::after{
      content:"";
      position:fixed;
      inset:0;
      background: linear-gradient(to bottom, rgba(0,0,0,0.04) 6%, rgba(0,0,0,0.20) 92%);
      z-index:-1;
    }

    /* Layout sections */
    section.panel{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0 1.25rem 12vh;
      text-align:center;
      opacity:0;
      transform:translateY(22px);
      transition:opacity 0.9s ease, transform 0.9s ease;
    }
    section.panel.active{opacity:1;transform:translateY(0)}

    /* Logos and header */
    .logo-row{
      position:fixed;
      left:0;right:0;top:1rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:0 1.25rem;
      z-index:40;
      pointer-events:none;
    }
    .logo-row img{height:72px;pointer-events:auto}
    .logo-row .left,.logo-row .right{pointer-events:auto}

    .hero-title-wrap{
      position:fixed;
      top:5.25rem;
      left:50%;
      transform:translateX(-50%);
      z-index:40;
      text-align:center;
      pointer-events:none;
    }
    .hero-title-main{font-weight:600;font-size:1.15rem;text-shadow:0 2px 10px rgba(0,0,0,0.6)}
    .hero-title-sub{font-size:0.95rem;opacity:0.95;margin-top:0.18rem}

    /* hero lower area (glass cards) */
    .hero-area{position:relative;z-index:30;max-width:920px;width:96%;margin:0 auto;display:flex;flex-direction:column;align-items:center;gap:12px;padding-bottom:18vh}
    .glass{
      background:rgba(255,255,255,0.22);
      border-radius:14px;
      padding:12px 18px;
      backdrop-filter:blur(10px);
      border:1px solid rgba(255,255,255,0.33);
      color:#031026;
      box-shadow:0 18px 50px rgba(0,0,0,0.55);
      max-width:820px;
      width:100%;
    }

    .verse-block{font-family:"Times New Roman",serif;font-style:italic;font-size:1rem;line-height:1.5}
    .verse-ref{font-size:0.86rem;margin-top:6px;display:block;opacity:0.92}

    .ida-title{font-family:"Times New Roman",serif;font-style:italic;font-size:0.95rem;margin-top:2px}
    .ida-preview{font-family:"Times New Roman",serif;font-style:italic;font-size:0.9rem;opacity:0.96;margin-top:6px}

    .hero-actions{display:flex;flex-direction:column;align-items:center;gap:8px;margin-top:6px}
    .link-button{
      padding:8px 14px;border-radius:999px;border:1px solid rgba(255,255,255,0.75);
      background:rgba(9,14,21,0.36);color:#eef2ff;font-weight:600;cursor:pointer;
    }
    .link-button:hover{transform:translateY(-2px)}

    .scroll-hint{margin-top:6px;color:rgba(255,255,255,0.9);font-size:0.82rem;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
    .arrow{font-size:1.15rem;animation:bounce 1.6s infinite}
    @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(4px)}}

    /* Contest card */
    .contest-card{max-width:820px;width:96%;text-align:left;padding:20px;border-radius:14px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(9,14,21,0.72);font-size:12px;letter-spacing:.16em;color:#e6eef9;border:1px solid rgba(200,210,230,0.12)}
    .contest-card h2{font-size:1.3rem;margin:10px 0}
    .contest-card p{line-height:1.6;color:rgba(240,246,255,0.94)}
    .contest-card ul{margin-left:1rem;line-height:1.6}

    /* Passport area */
    #passport{align-items:flex-start;padding-top:18vh}
    .content-wrap{max-width:1024px;width:98%;margin:0 auto;display:flex;flex-direction:column;gap:18px}
    .auth-card,.grid-card{padding:18px;border-radius:14px;text-align:left}
    .auth-top{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .auth-title{font-weight:700}
    #auth-status{font-size:0.86rem;opacity:0.92}
    input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(180,190,220,0.34);background:rgba(6,10,16,0.65);color:#eef2ff;margin-top:8px;font-size:0.95rem}
    .auth-buttons{display:flex;gap:10px;margin-top:12px}
    .btn-register{background:rgba(154,211,188,0.95);color:#043024;padding:10px 16px;border-radius:999px;border:none;cursor:pointer}
    .btn-login{background:rgba(139,188,230,0.95);color:#06253b;padding:10px 16px;border-radius:999px;border:none;cursor:pointer}
    .hint{font-size:0.85rem;opacity:0.9;margin-top:8px}

    /* grid */
    .grid-header{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
    .welcome-line{font-size:0.95rem;font-weight:600}
    .grid-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:10px;margin-top:12px}
    .neon-stall{padding:12px;border-radius:12px;background:radial-gradient(circle at top,#071025,#02101a 85%);border:1px solid rgba(34,211,238,0.48);color:#a8f6ff;font-weight:700;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:6px;box-shadow:0 10px 24px rgba(10,40,60,0.55)}
    .neon-stall:hover{transform:translateY(-4px);box-shadow:0 18px 36px rgba(10,40,60,0.75)}
    .neon-stall.visited{border-color:rgba(74,222,128,0.95);box-shadow:0 18px 36px rgba(20,60,40,0.6);background:linear-gradient(180deg,#032a16,#011212);color:#ccffd6}

    /* leader */
    #leaderboard{margin-top:14px}
    .leader-header{display:flex;justify-content:space-between;align-items:center;gap:8px}
    #leader-list{margin-top:8px;font-size:0.92rem;color:#e8f6ff;max-height:260px;overflow:auto;padding-right:6px;text-align:left}
    #leader-list .row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.03)}
    .btn-refresh{background:rgba(139,188,230,0.95);color:#06253b;padding:8px 12px;border-radius:999px;border:none;cursor:pointer}

    /* prayer modal */
    #prayer-modal{position:fixed;inset:0;background:rgba(3,6,12,0.65);display:none;align-items:center;justify-content:center;padding:12px;z-index:120}
    .prayer-card{background:rgba(255,255,255,0.16);backdrop-filter:blur(12px);padding:18px;border-radius:12px;max-width:720px;color:#031025;max-height:80vh;overflow:auto}

    /* qr overlay */
    #qr-overlay{position:fixed;inset:0;background:rgba(2,6,12,0.92);display:none;align-items:center;justify-content:center;z-index:130;padding:18px}
    #qr-reader{width:360px;max-width:96%;background:#000;border-radius:12px;overflow:hidden}

    /* toast */
    #toast{position:fixed;left:50%;transform:translateX(-50%) translateY(12px);bottom:28px;background:#021021;color:#e9f9ff;padding:10px 16px;border-radius:999px;opacity:0;pointer-events:none;z-index:200;transition:opacity .28s,transform .28s}
    #toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

    /* responsive tweaks */
    @media(max-width:820px){
      .logo-row img{height:56px}
      .hero-title-wrap{top:4.2rem}
      .neon-stall{padding:10px}
    }
    @media(max-width:420px){
      .hero-title-main{font-size:1rem}
      .hero-title-sub{font-size:0.82rem}
      .verse-block{font-size:0.94rem}
    }
  </style>

  <!-- html5-qrcode -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>

  <!-- Logos -->
  <div class="logo-row">
    <div class="left"><img src="assets/iria2025.png" alt="IRIA Logo"></div>
    <div class="right"><img src="assets/cmc.png" alt="CMC Logo"></div>
  </div>

  <!-- Hero title (fixed) -->
  <div class="hero-title-wrap" aria-hidden="true">
    <div class="hero-title-main">Welcome to the 78th Annual TNPY IRIA Conference</div>
    <div class="hero-title-sub">at Christian Medical College, Vellore</div>
  </div>

  <!-- HERO (one panel visually; cards inside) -->
  <section id="hero" class="panel" style="align-items:flex-end;padding-bottom:18vh;">
    <div class="hero-area" id="hero-area">
      <!-- Verse glass (separate) -->
      <div class="glass verse-glass">
        <div class="verse-block">
          “Even as the Son of man came not to be ministered unto, but to minister,
          and to give his life a ransom for many.”
          <span class="verse-ref">Matthew 20:28</span>
        </div>
      </div>

      <!-- Ida glass (separate) -->
      <div class="glass" id="ida-preview">
        <div class="ida-title">Aunt Ida’s Prayer</div>
        <div class="ida-preview">Father, whose life is within me, and whose love is ever about me…</div>
      </div>

      <!-- actions: read prayer + scroll -->
      <div class="hero-actions">
        <button class="link-button" onclick="openPrayerModal()">Read the full prayer</button>
        <div class="scroll-hint" onclick="scrollToContest()">Scroll to start the Stall Grid Contest <span class="arrow">↓</span></div>
      </div>
    </div>
  </section>

  <!-- Contest intro -->
  <section id="contest" class="panel">
    <div class="contest-card glass">
      <div class="pill">Stall Grid Contest</div>
      <h2>Explore, Scan & Win at IRIA 2025</h2>
      <p>
        During the 78<sup>th</sup> Annual TNPY IRIA Conference at CMC Vellore,
        the Stall Grid Passport turns your visit to the trade area into an interactive
        challenge. Meet exhibitors, discover new technologies and collect digital ticks
        by scanning QR codes at each stall.
      </p>
      <p><strong>How it works:</strong></p>
      <ul>
        <li>Register once with your name, email and a password.</li>
        <li>Login on your phone or tablet using the same email.</li>
        <li>Tap a stall tile and scan the QR code displayed at that exhibitor’s stall.</li>
        <li>Each successful scan marks the stall as visited with a tick.</li>
        <li>Your total visited stalls contribute to the live leaderboard.</li>
      </ul>
    </div>
  </section>

  <!-- Passport / auth / grid -->
  <section id="passport" class="panel">
    <div class="content-wrap">
      <!-- Auth card -->
      <div class="auth-card glass" id="auth-card">
        <div class="auth-top">
          <div>
            <div class="pill">Delegate Login</div>
            <div class="auth-title">Access Your Stall Grid Passport</div>
          </div>
          <div style="display:flex;align-items:center;gap:10px">
            <div id="auth-status">Not signed in</div>
            <div id="logout-btn" class="hidden"><button class="btn-login" onclick="logoutUser()">Logout</button></div>
          </div>
        </div>

        <input id="name-input" placeholder="Name (as registration)" />
        <input id="email-input" placeholder="Email (same as registration)" />
        <input id="delegate-input" placeholder="Delegate ID (optional)" />
        <input id="password-input" type="password" placeholder="Password" />

        <div class="auth-buttons">
          <button class="btn-register" onclick="registerUser()">Register</button>
          <button class="btn-login" onclick="loginUser()">Login</button>
        </div>

        <p class="hint">
          Use the same name and email as your conference registration to be eligible for prizes.
          Please choose a password different from the one used for your email account.
        </p>
      </div>

      <!-- Grid + leaderboard (hidden until login) -->
      <div class="grid-card glass hidden" id="grid-card">
        <div class="grid-header">
          <div>
            <div class="pill">Stall Grid</div>
            <div style="font-size:0.98rem;font-weight:600;margin-top:6px;">Scan QR at Each Exhibitor</div>
            <p style="font-size:0.85rem;opacity:0.95;margin-top:6px;">Tap a stall tile to open the camera. After scanning, the stall will glow and your visit counts towards the live leaderboard.</p>
          </div>
        </div>

        <div id="user-banner" class="welcome-line hidden"></div>

        <div id="grid" class="grid-container" aria-live="polite"></div>

        <div id="leaderboard" style="margin-top:16px">
          <div class="leader-header">
            <div>
              <div class="pill">Leaderboard</div>
              <div style="font-size:0.95rem;font-weight:600;margin-top:6px;">Most Active Stall Explorers</div>
            </div>
            <button class="btn-refresh" onclick="manualRefreshLeaderboard()">Refresh</button>
          </div>
          <div id="leader-list" role="list"></div>
        </div>

        <div style="margin-top:10px;text-align:center;">
          <div class="scroll-hint" onclick="scrollToLeaderboard()">Scroll down for leaderboard <span class="arrow">↓</span></div>
        </div>
      </div>
    </div>
  </section>

  <!-- QR overlay -->
  <div id="qr-overlay" aria-hidden="true">
    <div id="qr-reader"></div>
    <button id="qr-close" onclick="closeScanner()" style="margin-top:12px;padding:8px 12px;border-radius:999px;border:none;background:#0b1726;color:#e7f6ff;">Close</button>
  </div>

  <!-- Prayer modal -->
  <div id="prayer-modal" aria-hidden="true">
    <div class="prayer-card">
      <h3 style="font-family:Times New Roman,serif;font-style:italic">Aunt Ida’s Prayer</h3>
      <p style="font-family:Times New Roman,serif;font-style:italic">Father, whose life is within me,</p>
      <p style="font-family:Times New Roman,serif;font-style:italic">and whose love is ever about me,</p>
      <p style="font-family:Times New Roman,serif;font-style:italic">Grant that Thy life may be maintained in my life today and every day,</p>
      <p style="font-family:Times New Roman,serif;font-style:italic">as with gladness of heart, without haste or confusion of thought,</p>
      <p style="font-family:Times New Roman,serif;font-style:italic">I go about my daily tasks,</p>
      <p style="font-family:Times New Roman,serif;font-style:italic">conscious of the ability to meet every rightful demand,</p>
      <p style="font-family:Times New Roman,serif;font-style:italic">seeing the larger meaning of little things,</p>
      <p style="font-family:Times New Roman,serif;font-style:italic">and finding beauty and love everywhere.</p>
      <p style="font-family:Times New Roman,serif;font-style:italic">In the sense of Thy presence, may I walk through the hours,</p>
      <p style="font-family:Times New Roman,serif;font-style:italic">breathing the atmosphere of love rather than anxious striving...</p>
      <p style="margin-top:8px;font-style:italic">— Dr. Ida S. Scudder</p>
      <div style="text-align:right;margin-top:8px"><button class="link-button" onclick="closePrayerModal()">Close</button></div>
    </div>
  </div>

  <div id="toast" role="status"></div>

  <!-- Main app logic -->
  <script type="module">
    import {
  getAuth,
  setPersistence,
  browserLocalPersistence,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut,
  updateProfile
} from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
    
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      getDocs,
      collection,
      serverTimestamp,
      query,
      orderBy
    } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

    // ---------- FIREBASE CONFIG ----------
    const firebaseConfig = {
      apiKey: "AIzaSyCMQDWuUnVCbfr5Sozj9c2XMkISkc7WB00",
      authDomain: "cmc-stallgrid-passport.firebaseapp.com",
      projectId: "cmc-stallgrid-passport",
      storageBucket: "cmc-stallgrid-passport.appspot.com",
      messagingSenderId: "729984975490",
      appId: "1:729984975490:web:757bca01efebe3149caa9b"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    // Make auth persist across browser restarts (keeps you signed in on phone)
setPersistence(auth, browserLocalPersistence).catch(err=>{
  console.warn("Could not set auth persistence:", err);
});

    const db = getFirestore(app);

    // ELEMENTS
    const panels = document.querySelectorAll("section.panel");
    const heroLower = document.getElementById("hero-area");
    const prayerModal = document.getElementById("prayer-modal");
    const toastEl = document.getElementById("toast");
    const authStatus = document.getElementById("auth-status");
    const authCard = document.getElementById("auth-card");
    const gridCard = document.getElementById("grid-card");
    const userBanner = document.getElementById("user-banner");
    const logoutBtn = document.getElementById("logout-btn");
    const gridEl = document.getElementById("grid");
    const leaderListEl = document.getElementById("leader-list");

    // Intersection observer for simple crossfade hero -> contest
    const observer = new IntersectionObserver((entries)=>{
      entries.forEach(entry=>{
        if(entry.isIntersecting){
          entry.target.classList.add("active");
          if(entry.target.id === "contest"){
            // fade hero cards slightly
            heroLower.classList.add("fade-out");
            // subtle blur (keep background visible)
            document.querySelectorAll(".glass").forEach(g=>{
              if(g.closest("#hero")) g.style.opacity = "0.0";
            });
          } else {
            // when hero visible again restore
            document.querySelectorAll(".glass").forEach(g=>{
              if(g.closest("#hero")) g.style.opacity = "1";
            });
          }
        }
      });
    },{threshold:0.28});
    panels.forEach(p=>observer.observe(p));

    // Scroll helpers
    window.scrollToContest = ()=>document.getElementById("contest").scrollIntoView({behavior:"smooth"});
    window.scrollToLeaderboard = ()=>document.getElementById("leaderboard").scrollIntoView({behavior:"smooth",block:"start"});

    // Prayer modal
    window.openPrayerModal = ()=>{ prayerModal.style.display='flex'; prayerModal.setAttribute('aria-hidden','false'); };
    window.closePrayerModal = ()=>{ prayerModal.style.display='none'; prayerModal.setAttribute('aria-hidden','true'); };

    // Toast
    function showToast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      toastEl.style.opacity = '1';
      setTimeout(()=>{ toastEl.classList.remove('show'); toastEl.style.opacity='0' },2200);
    }

    // AUTH UI wiring
    const nameInput = document.getElementById("name-input");
    const emailInput = document.getElementById("email-input");
    const passInput = document.getElementById("password-input");
    const delegateInput = document.getElementById("delegate-input");

    async function registerUser(){
      const name = nameInput.value.trim();
      const email = emailInput.value.trim();
      const pass = passInput.value.trim();
      const del = delegateInput.value.trim();
      if(!name||!email||!pass){ alert("Name, email and password required"); return; }
      try{
        const cred = await createUserWithEmailAndPassword(auth,email,pass);
        if(name) await updateProfile(cred.user,{displayName:name});
        await setDoc(doc(db,"users",cred.user.uid),{ name, email, delegateId: del||null, createdAt: serverTimestamp() },{merge:true});
        showToast("Registered & signed in");
        // show grid
        document.getElementById("passport").scrollIntoView({behavior:"smooth"});
      }catch(e){
        alert(e.message||String(e));
      }
    }
    window.registerUser = registerUser;

    async function loginUser(){
      const email = emailInput.value.trim();
      const pass = passInput.value.trim();
      if(!email||!pass){ alert("Enter email & password"); return; }
      try{
        await signInWithEmailAndPassword(auth,email,pass);
        showToast("Logged in");
        document.getElementById("passport").scrollIntoView({behavior:"smooth"});
      }catch(e){
        alert(e.message||String(e));
      }
    }
    window.loginUser = loginUser;

    window.logoutUser = async function(){
      try{
        await signOut(auth);
        showToast("Logged out");
      }catch(e){
        console.error(e);
      }
    };

    onAuthStateChanged(auth, async (user)=>{
      if(user){
        const display = user.displayName || user.email || "Delegate";
        authStatus.textContent = `Signed in as ${display}`;
        authCard.classList.add("hidden");
        gridCard.classList.remove("hidden");
        logoutBtn.classList.remove("hidden");

        // fetch profile
        try{
          const ps = await getDoc(doc(db,"users",user.uid));
          if(ps.exists()){
            const data = ps.data();
            const nm = data.name || display;
            const del = data.delegateId;
            userBanner.textContent = del ? `Welcome, ${nm} (Delegate ID: ${del})` : `Welcome, ${nm}`;
          }else{
            userBanner.textContent = `Welcome, ${display}`;
          }
        }catch(e){
          userBanner.textContent = `Welcome, ${display}`;
        }
        userBanner.classList.remove("hidden");

        await loadUserVisits(user.uid);
        await loadLeaderboard();
      } else {
        authStatus.textContent = "Not signed in";
        authCard.classList.remove("hidden");
        gridCard.classList.add("hidden");
        userBanner.classList.add("hidden");
        logoutBtn.classList.add("hidden");
        // clear UI
        clearVisitedStalls();
        leaderListEl.innerHTML = "";
      }
    });

    // STALL GRID: dynamic from Firestore 'stalls' collection (Option A: simple list)
    let stallDocs = [];
    async function buildGridFromFirestore(){
      gridEl.innerHTML = "";
      try{
        const snap = await getDocs(collection(db,"stalls"));
        if(snap.empty){
          // fallback: generate 12 generic stalls if none exist
          for(let i=1;i<=12;i++){
            const id = `Stall ${i}`;
            createStallCard({ id, name: id});
          }
          return;
        }
        stallDocs = [];
        snap.forEach(docSnap=>{
          const docId = docSnap.id;
          const data = docSnap.data() || {};
          // name fallback: doc.id or data.name
          const name = data.name || docId;
          stallDocs.push({ id: docId, name });
        });
        // sort by id if possible
        stallDocs.sort((a,b)=> a.name.localeCompare(b.name,undefined,{numeric:true}));
        stallDocs.forEach(s=>createStallCard(s));
      }catch(e){
        console.error("Error loading stalls",e);
        // fallback generic
        for(let i=1;i<=12;i++) createStallCard({id:`Stall ${i}`,name:`Stall ${i}`});
      }
    }

    function createStallCard(stall){
      const div = document.createElement("div");
      div.className = "neon-stall";
      div.dataset.stallId = stall.name;
      div.innerHTML = `<div style="font-size:0.95rem">${stall.name}</div><div style="font-size:0.78rem;opacity:0.9">Tap to scan</div>`;
      div.addEventListener("click", ()=>openScanner(stall.name));
      gridEl.appendChild(div);
    }

    function clearVisitedStalls(){
      document.querySelectorAll(".neon-stall").forEach(c=>{
        c.classList.remove("visited");
        c.innerHTML = `<div style="font-size:0.95rem">${c.dataset.stallId}</div><div style="font-size:0.78rem;opacity:0.9">Tap to scan</div>`;
      });
    }

    function markStallVisited(stallName){
      document.querySelectorAll(".neon-stall").forEach(card=>{
        if(card.dataset.stallId === stallName){
          card.classList.add("visited");
          card.innerHTML = `<div style="font-size:0.95rem">${stallName} ✓</div><div style="font-size:0.78rem;opacity:0.9">Visited</div>`;
        }
      });
    }

    async function loadUserVisits(uid){
      try{
        const snap = await getDocs(collection(db,"visits",uid,"stalls"));
        snap.forEach(docSnap=>{
          markStallVisited(docSnap.id);
        });
      }catch(e){
        console.error("Error loading visits",e);
      }
    }

    // QR scanner using html5-qrcode
    let html5QrInstance = null;
    let currentStallName = null;
    const qrOverlay = document.getElementById("qr-overlay");

    async function openScanner(stallName){
      if(!auth.currentUser){ alert("Please login first to record visits."); return; }
      currentStallName = stallName;
      qrOverlay.style.display = "flex";
      const regionId = "qr-reader";
      if(!html5QrInstance) html5QrInstance = new Html5Qrcode(regionId);

      try{
        await html5QrInstance.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          async (decodedText) => {
            try{ await html5QrInstance.stop(); }catch(_){}
            qrOverlay.style.display = "none";
            await recordVisit(currentStallName, decodedText);
          },
          (err)=>{ /* ignore decode failures */ }
        );
      }catch(err){
        qrOverlay.style.display = "none";
        alert("Camera error: " + (err.message||err));
      }
    }
    window.openScanner = openScanner;

    async function closeScanner(){
      qrOverlay.style.display = "none";
      if(html5QrInstance){
        try{ await html5QrInstance.stop(); }catch(_){}
      }
    }
    window.closeScanner = closeScanner;

    // record visit to Firestore
    async function recordVisit(stallName, qrText){
      const user = auth.currentUser;
      if(!user) return;
      const uid = user.uid;
      try{
        await setDoc(doc(db,"visits",uid),{ updatedAt: serverTimestamp() },{merge:true});
        await setDoc(doc(db,"visits",uid,"stalls",stallName),{ stall: stallName, scannedText: qrText||null, visitedAt: serverTimestamp() },{merge:true});
        markStallVisited(stallName);
        showToast(`Recorded visit: ${stallName}`);
        await loadLeaderboard();
      }catch(e){
        console.error("Error recording visit",e);
        alert("Could not record visit. Try again.");
      }
    }

    // Firestore-native leaderboard (counts visits per user)
    async function loadLeaderboard(){
      leaderListEl.innerHTML = '<div style="padding:8px 0;color:rgba(240,248,255,0.9)">Loading…</div>';
      try{
        const visitsSnap = await getDocs(collection(db,"visits"));
        const rows = [];
        for(const docSnap of visitsSnap.docs){
          const uid = docSnap.id;
          const stallsSnap = await getDocs(collection(db,"visits",uid,"stalls"));
          const count = stallsSnap.size;
          if(count===0) continue;
          let displayName = uid.substring(0,6);
          try{
            const userDoc = await getDoc(doc(db,"users",uid));
            if(userDoc.exists()){
              const d = userDoc.data();
              displayName = d.name || d.delegateId || d.email || displayName;
            }
          }catch(_){}
          rows.push({ uid, displayName, count });
        }
        rows.sort((a,b)=>b.count - a.count);
        if(rows.length===0){ leaderListEl.innerHTML = '<div style="padding:8px 0;color:rgba(240,248,255,0.7)">No visits recorded yet.</div>'; return; }
        leaderListEl.innerHTML = '';
        rows.forEach((r,i)=>{
          const row = document.createElement('div');
          row.className = 'row';
          row.innerHTML = `<div style="font-weight:700">${i+1}. ${r.displayName}</div><div style="opacity:0.9">${r.count} stall${r.count===1?"":"s"}</div>`;
          leaderListEl.appendChild(row);
        });
      }catch(e){
        console.error("Leaderboard error",e);
        leaderListEl.innerHTML = '<div style="padding:8px 0;color:#ffdddd">Error loading leaderboard.</div>';
      }
    }

    window.manualRefreshLeaderboard = function(){
      loadLeaderboard().then(()=>showToast("Leaderboard refreshed"));
    };

    // initial build: stalls + leader
    await buildGridFromFirestore();
    // auto-load leaderboard on page load if user already signed in (onAuthStateChanged handles it)

    // call loadLeaderboard occasionally as extra safety (but only when visible)
    let leaderTimer = setInterval(()=>{ if(document.visibilityState==='visible') loadLeaderboard(); }, 15000);

  </script>
</body>
</html>

