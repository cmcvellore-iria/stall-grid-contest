<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CMC Stall Grid Passport – IRIA 2025</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- EXPECTED ASSETS in ./assets:
       - chapel-hero.jpg
       - cmc.png
       - iria2025.png
  -->

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      color:#f8fafc;
      background:#020617;
      overflow-x:hidden;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* HERO background (full-screen) */
    #hero{
      position:relative;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    #hero::before{
      content:"";
      position:absolute;
      inset:0;
      background: url("assets/chapel-hero.jpg") center 12% / cover no-repeat;
      z-index:-3;
      filter:brightness(1.08); /* 10% brighter as requested */
      background-attachment: fixed;
    }
    /* gentle global overlay to keep text readable but let chapel show */
    #hero::after{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(to bottom, rgba(0,0,0,0.02) 5%, rgba(0,0,0,0.18) 90%);
      z-index:-2;
    }

    /* fixed logos & title */
    .logo-row{
      position:fixed;
      top:0.9rem;
      left:0; right:0;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:0 1.25rem;
      z-index:60;
      pointer-events:none;
    }
    .logo-row img{height:83px;pointer-events:auto} /* +15% from 72 -> 83 */
    .hero-title-wrap{
      position:fixed;
      top:3.6rem;
      left:50%;
      transform:translateX(-50%);
      z-index:50;
      text-align:center;
      pointer-events:none;
      color:#0b1a2b;
      text-shadow:0 1px 0 rgba(255,255,255,0.06);
    }
    .hero-title-main{font-weight:700;font-size:1.7rem;color: #071033}
    .hero-title-sub{font-size:1rem;opacity:0.92;margin-top:0.2rem;color:#0b1a2b}

    /* POND AREA: position glass boxes low on the hero, above the pond */
    .hero-bottom-wrap{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      z-index:40;
      width:94%;
      max-width:1080px;
      bottom:10vh; /* park near the pond; tweak to taste */
      display:flex;
      flex-direction:column;
      gap:14px;
      align-items:center;
      pointer-events:auto;
    }

    /* frosted glass card (readable, not colored) */
    .glass{
      width:100%;
      border-radius:14px;
      padding:16px 20px;
      background:rgba(255,255,255,0.12);
      backdrop-filter: blur(10px) saturate(120%);
      border:1px solid rgba(255,255,255,0.15);
      color:#041022;
      box-shadow:0 10px 36px rgba(0,0,0,0.45);
      transition:transform 0.7s cubic-bezier(.2,.9,.2,1), opacity 0.7s ease;
      opacity:0; transform:translateY(12px);
    }
    .glass.revealed{opacity:1; transform:translateY(0)}
    .verse-block{font-family:"Times New Roman",serif;font-style:italic;font-size:1.05rem;line-height:1.45;color:#082033}
    .verse-ref{font-size:0.9rem;margin-top:8px;display:block;color:#072033;opacity:0.95}

    .ida-title{font-family:"Times New Roman",serif;font-weight:700;font-size:1.02rem;text-align:center;margin-bottom:6px;color:#072033}
    .ida-preview{font-family:"Times New Roman",serif;font-size:0.95rem;text-align:center;color:#07303a;opacity:0.96}

    /* actions below the glass boxes (visible on first view) */
    .hero-actions{
      display:flex;
      gap:18px;
      align-items:center;
      margin-top:6px;
      z-index:45;
    }
    .link-button{
      padding:10px 18px;border-radius:999px;border:2px solid rgba(255,255,255,0.14);
      background:rgba(9,14,21,0.18);color:#0b1730;font-weight:700;cursor:pointer;
      backdrop-filter:blur(4px);
    }
    .scroll-hint{color:#081a2b;opacity:0.9;font-weight:600}

    /* PASSPORT section placeholder (follows below hero) */
    section.panel{
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:6vh 1.25rem 10vh;
      background:transparent;
    }

    /* Grid and cards inside passport area */
    .content-wrap{max-width:1024px;width:98%;margin:0 auto;display:flex;flex-direction:column;gap:18px}
    .auth-card,.grid-card{padding:18px;border-radius:14px;text-align:left;background:rgba(255,255,255,0.06);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.06)}

    input{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(6,10,16,0.6);color:#eef2ff;margin-top:8px;font-size:0.95rem}

    .grid-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:10px;margin-top:12px}
    .neon-stall{
      padding:12px;border-radius:12px;background:radial-gradient(circle at top,#071025,#02101a 85%);border:1px solid rgba(34,211,238,0.48);
      color:#a8f6ff;font-weight:700;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:6px;
      box-shadow:0 10px 24px rgba(10,40,60,0.45);
      transition:transform .28s cubic-bezier(.2,.9,.2,1), box-shadow .28s, border-color .28s;
    }
    /* subtle neon pop (restored) */
    .neon-stall:hover{transform:translateY(-6px) scale(1.02);box-shadow:0 22px 56px rgba(25,120,170,0.18);border-color:rgba(34,211,238,0.86)}

    /* visited state */
    .neon-stall.visited{border-color:rgba(74,222,128,0.95);box-shadow:0 18px 36px rgba(20,60,40,0.5);background:linear-gradient(180deg,#032a16,#011212);color:#ccffd6}

    /* leaderboard */
    #leader-list{margin-top:8px;font-size:0.94rem;color:#e8f6ff;max-height:260px;overflow:auto;padding-right:6px}
    #leader-list .row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.03)}

    /* QR overlay and toast */
    #qr-overlay{position:fixed;inset:0;background:rgba(2,6,12,0.92);display:none;align-items:center;justify-content:center;z-index:130;padding:18px}
    #qr-reader{width:360px;max-width:96%;background:#000;border-radius:12px;overflow:hidden}
    #toast{position:fixed;left:50%;transform:translateX(-50%) translateY(12px);bottom:28px;background:#021021;color:#e9f9ff;padding:10px 16px;border-radius:999px;opacity:0;pointer-events:none;z-index:200;transition:opacity .28s,transform .28s}
    #toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

    /* small screens */
    @media(max-width:820px){
      .logo-row img{height:66px}
      .hero-title-wrap{top:3.2rem}
      .hero-bottom-wrap{bottom:8vh;width:96%}
      .glass{padding:12px}
      .neon-stall{padding:10px}
    }
    @media(max-width:420px){
      .hero-title-main{font-size:1.25rem}
      .verse-block{font-size:0.95rem}
    }
  </style>

  <!-- html5-qrcode -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>

  <!-- Logos -->
  <div class="logo-row">
    <div class="left"><img src="assets/iria2025.png" alt="IRIA Logo"></div>
    <div class="right"><img src="assets/cmc.png" alt="CMC Logo"></div>
  </div>

  <!-- Hero title (fixed) -->
  <div class="hero-title-wrap" aria-hidden="true">
    <div class="hero-title-main">Welcome to the 78th Annual TNPY IRIA Conference</div>
    <div class="hero-title-sub">at Christian Medical College, Vellore</div>
  </div>

  <!-- HERO -->
  <section id="hero">
    <!-- bottom glass cluster (placed at pond level) -->
    <div class="hero-bottom-wrap" id="hero-bottom">
      <div class="glass verse-glass" id="verse-glass" aria-hidden="true">
        <div class="verse-block">
          “Even as the Son of man came not to be ministered unto, but to minister,
          and to give his life a ransom for many.”
          <span class="verse-ref">Matthew 20:28</span>
        </div>
      </div>

      <div class="glass" id="ida-glass" aria-hidden="true">
        <div class="ida-title">Aunt Ida’s Prayer</div>
        <div class="ida-preview">Father, whose life is within me, and whose love is ever about me…</div>
      </div>

      <div class="hero-actions" aria-hidden="true">
        <button class="link-button" onclick="openPrayerModal()">Read the full prayer</button>
        <div class="scroll-hint" onclick="document.getElementById('passport').scrollIntoView({behavior:'smooth'})">Scroll to start the Stall Grid Contest ↓</div>
      </div>
    </div>
  </section>

  <!-- Passport / auth / grid -->
  <section id="passport" class="panel">
    <div class="content-wrap">
      <!-- Auth card -->
      <div class="auth-card glass" id="auth-card" aria-live="polite">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="pill">Delegate Login</div>
            <div style="font-weight:700;margin-top:8px">Access Your Stall Grid Passport</div>
          </div>
          <div id="auth-status" style="opacity:0.92">Not signed in</div>
        </div>

        <input id="name-input" placeholder="Name (as registration)" />
        <input id="email-input" placeholder="Email (same as registration)" />
        <input id="delegate-input" placeholder="Delegate ID (optional)" />
        <input id="password-input" type="password" placeholder="Password" />

        <div style="display:flex;gap:10px;margin-top:12px">
          <button style="background:#9adebc;color:#043024;padding:10px 16px;border-radius:999px;border:none;cursor:pointer" onclick="registerUser()">Register</button>
          <button style="background:#8bbce6;color:#06253b;padding:10px 16px;border-radius:999px;border:none;cursor:pointer" onclick="loginUser()">Login</button>
        </div>

        <p style="margin-top:12px;opacity:0.9">Use the same name and email as your conference registration to be eligible for prizes.</p>
      </div>

      <!-- Grid + leaderboard -->
      <div class="grid-card glass" id="grid-card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="pill">Stall Grid</div>
            <div style="font-weight:700;margin-top:8px">Scan QR at Each Exhibitor</div>
          </div>
          <button style="padding:8px 12px;border-radius:999px;background:#8bbce6;border:none;cursor:pointer" onclick="manualRefreshLeaderboard()">Refresh</button>
        </div>

        <div id="user-banner" style="margin-top:8px;opacity:0.95;display:none"></div>

        <div id="grid" class="grid-container" aria-live="polite"></div>

        <div id="leaderboard" style="margin-top:16px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="pill">Leaderboard</div>
            </div>
          </div>
          <div id="leader-list" role="list"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- QR overlay -->
  <div id="qr-overlay" aria-hidden="true">
    <div id="qr-reader"></div>
    <button id="qr-close" onclick="closeScanner()" style="margin-top:12px;padding:8px 12px;border-radius:999px;border:none;background:#0b1726;color:#e7f6ff;">Close</button>
  </div>

  <!-- Prayer modal -->
  <div id="prayer-modal" aria-hidden="true" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;z-index:220;padding:18px;background:rgba(2,6,12,0.6)">
    <div style="background:rgba(255,255,255,0.18);backdrop-filter:blur(12px);padding:18px;border-radius:12px;max-width:720px;color:#041022">
      <h3 style="font-family:Times New Roman,serif;font-style:italic">Aunt Ida’s Prayer</h3>
      <div style="font-family:Times New Roman,serif;font-style:italic">Father, whose life is within me, and whose love is ever about me…</div>
      <div style="text-align:right;margin-top:12px"><button class="link-button" onclick="closePrayerModal()">Close</button></div>
    </div>
  </div>

  <div id="toast" role="status"></div>

  <!-- Main app logic -->
  <script type="module">

    /* ---------- MOBILE SAFARI VIEWPORT FIX (place here at top of module) ---------- */
    function setRealVH(){
      document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px');
    }
    setRealVH();
    window.addEventListener('resize', setRealVH);
    window.addEventListener('orientationchange', setRealVH);

    // Firebase imports (keeps your existing flow)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
    import {
      getAuth,
      setPersistence,
      browserLocalPersistence,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";

    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      getDocs,
      collection,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCMQDWuUnVCbfr5Sozj9c2XMkISkc7WB00",
      authDomain: "cmc-stallgrid-passport.firebaseapp.com",
      projectId: "cmc-stallgrid-passport",
      storageBucket: "cmc-stallgrid-passport.appspot.com",
      messagingSenderId: "729984975490",
      appId: "1:729984975490:web:757bca01efebe3149caa9b"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    setPersistence(auth, browserLocalPersistence).catch(()=>{});
    const db = getFirestore(app);

    // ELEMENTS
    const verseGlass = document.getElementById('verse-glass');
    const idaGlass = document.getElementById('ida-glass');
    const heroBottom = document.getElementById('hero-bottom');
    const prayerModal = document.getElementById('prayer-modal');
    const toastEl = document.getElementById('toast');
    const authStatus = document.getElementById('auth-status');
    const gridEl = document.getElementById('grid');
    const leaderListEl = document.getElementById('leader-list');
    const userBanner = document.getElementById('user-banner');

    // reveal glass cards softly after small delay so chapel shows first
    window.addEventListener('load', ()=>{
      setTimeout(()=>{ verseGlass.classList.add('revealed'); }, 420);
      setTimeout(()=>{ idaGlass.classList.add('revealed'); }, 760);
      setTimeout(()=>{ document.querySelector('.hero-actions').style.opacity = 1; }, 940);
    });

    // Prayer modal
    window.openPrayerModal = ()=>{ prayerModal.style.display='flex'; prayerModal.setAttribute('aria-hidden','false'); };
    window.closePrayerModal = ()=>{ prayerModal.style.display='none'; prayerModal.setAttribute('aria-hidden','true'); };

    // Toast
    function showToast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      toastEl.style.opacity = '1';
      setTimeout(()=>{ toastEl.classList.remove('show'); toastEl.style.opacity='0' },2200);
    }

    // AUTH wiring
    const nameInput = document.getElementById("name-input");
    const emailInput = document.getElementById("email-input");
    const passInput = document.getElementById("password-input");
    const delegateInput = document.getElementById("delegate-input");

    async function registerUser(){
      const name = nameInput.value.trim();
      const email = emailInput.value.trim();
      const pass = passInput.value.trim();
      const del = delegateInput.value.trim();
      if(!name||!email||!pass){ alert("Name, email and password required"); return; }
      try{
        const cred = await createUserWithEmailAndPassword(auth,email,pass);
        if(name) await updateProfile(cred.user,{displayName:name});
        await setDoc(doc(db,"users",cred.user.uid),{ name, email, delegateId: del||null, createdAt: serverTimestamp() },{merge:true});
        showToast("Registered & signed in");
        document.getElementById("passport").scrollIntoView({behavior:"smooth"});
      }catch(e){
        alert(e.message||String(e));
      }
    }
    window.registerUser = registerUser;

    async function loginUser(){
      const email = emailInput.value.trim();
      const pass = passInput.value.trim();
      if(!email||!pass){ alert("Enter email & password"); return; }
      try{
        await signInWithEmailAndPassword(auth,email,pass);
        showToast("Logged in");
        document.getElementById("passport").scrollIntoView({behavior:"smooth"});
      }catch(e){
        alert(e.message||String(e));
      }
    }
    window.loginUser = loginUser;

    window.logoutUser = async function(){
      try{ await signOut(auth); showToast("Logged out"); }catch(e){ console.error(e); }
    };

    onAuthStateChanged(auth, async (user)=>{
      if(user){
        const display = user.displayName || user.email || "Delegate";
        authStatus.textContent = `Signed in as ${display}`;
        userBanner.style.display = 'block';
        try{
          const ps = await getDoc(doc(db,"users",user.uid));
          if(ps.exists()){
            const data = ps.data();
            const nm = data.name || display;
            const del = data.delegateId;
            userBanner.textContent = del ? `Welcome, ${nm} (Delegate ID: ${del})` : `Welcome, ${nm}`;
          }else userBanner.textContent = `Welcome, ${display}`;
        }catch(_){
          userBanner.textContent = `Welcome, ${display}`;
        }
        await loadUserVisits(user.uid);
        await loadLeaderboard();
      } else {
        authStatus.textContent = "Not signed in";
        userBanner.style.display = 'none';
        clearVisitedStalls();
        leaderListEl.innerHTML = "";
      }
    });

    // STALL GRID dynamic from Firestore 'stalls' collection
    let stallDocs = [];
    async function buildGridFromFirestore(){
      gridEl.innerHTML = "";
      try{
        const snap = await getDocs(collection(db,"stalls"));
        if(snap.empty){
          for(let i=1;i<=12;i++){ createStallCard({ id:`Stall ${i}`, name:`Stall ${i}` }); }
          return;
        }
        stallDocs = [];
        snap.forEach(docSnap=>{
          const docId = docSnap.id;
          const data = docSnap.data() || {};
          const name = data.name || docId;
          stallDocs.push({ id: docId, name });
        });
        stallDocs.sort((a,b)=> a.name.localeCompare(b.name,undefined,{numeric:true}));
        stallDocs.forEach(s=>createStallCard(s));
      }catch(e){
        console.error("Error loading stalls",e);
        for(let i=1;i<=12;i++) createStallCard({id:`Stall ${i}`,name:`Stall ${i}`});
      }
    }

    function createStallCard(stall){
      const div = document.createElement("div");
      div.className = "neon-stall";
      div.dataset.stallId = stall.name;
      div.innerHTML = `<div style="font-size:0.95rem">${stall.name}</div><div style="font-size:0.78rem;opacity:0.9">Tap to scan</div>`;
      div.addEventListener("click", ()=>openScanner(stall.name));
      gridEl.appendChild(div);
    }

    function clearVisitedStalls(){
      document.querySelectorAll(".neon-stall").forEach(c=>{
        c.classList.remove("visited");
        c.innerHTML = `<div style="font-size:0.95rem">${c.dataset.stallId}</div><div style="font-size:0.78rem;opacity:0.9">Tap to scan</div>`;
      });
    }

    function markStallVisited(stallName){
      document.querySelectorAll(".neon-stall").forEach(card=>{
        if(card.dataset.stallId === stallName){
          card.classList.add("visited");
          card.innerHTML = `<div style="font-size:0.95rem">${stallName} ✓</div><div style="font-size:0.78rem;opacity:0.9">Visited</div>`;
        }
      });
    }

    async function loadUserVisits(uid){
      try{
        const snap = await getDocs(collection(db,"visits",uid,"stalls"));
        snap.forEach(docSnap=>{
          markStallVisited(docSnap.id);
        });
      }catch(e){
        console.error("Error loading visits",e);
      }
    }

    // QR scanner using html5-qrcode
    let html5QrInstance = null;
    let currentStallName = null;
    const qrOverlay = document.getElementById("qr-overlay");

    async function openScanner(stallName){
      if(!auth.currentUser){ alert("Please login first to record visits."); return; }
      currentStallName = stallName;
      qrOverlay.style.display = "flex";
      const regionId = "qr-reader";
      if(!html5QrInstance) html5QrInstance = new Html5Qrcode(regionId);

      try{
        await html5QrInstance.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          async (decodedText) => {
            try{ await html5QrInstance.stop(); }catch(_){}
            qrOverlay.style.display = "none";
            await recordVisit(currentStallName, decodedText);
          },
          (err)=>{ /* ignore decode failures */ }
        );
      }catch(err){
        qrOverlay.style.display = "none";
        alert("Camera error: " + (err.message||err));
      }
    }
    window.openScanner = openScanner;

    async function closeScanner(){
      qrOverlay.style.display = "none";
      if(html5QrInstance){
        try{ await html5QrInstance.stop(); }catch(_){}
      }
    }
    window.closeScanner = closeScanner;

    // record visit to Firestore
    async function recordVisit(stallName, qrText){
      const user = auth.currentUser;
      if(!user) return;
      const uid = user.uid;
      try{
        await setDoc(doc(db,"visits",uid),{ updatedAt: serverTimestamp() },{merge:true});
        await setDoc(doc(db,"visits",uid,"stalls",stallName),{ stall: stallName, scannedText: qrText||null, visitedAt: serverTimestamp() },{merge:true});
        markStallVisited(stallName);
        showToast(`Recorded visit: ${stallName}`);
        await loadLeaderboard();
      }catch(e){
        console.error("Error recording visit",e);
        alert("Could not record visit. Try again.");
      }
    }

    // Firestore-native leaderboard (counts visits per user)
    async function loadLeaderboard(){
      leaderListEl.innerHTML = '<div style="padding:8px 0;color:rgba(240,248,255,0.9)">Loading…</div>';
      try{
        const visitsSnap = await getDocs(collection(db,"visits"));
        const rows = [];
        for(const docSnap of visitsSnap.docs){
          const uid = docSnap.id;
          const stallsSnap = await getDocs(collection(db,"visits",uid,"stalls"));
          const count = stallsSnap.size;
          if(count===0) continue;
          let displayName = uid.substring(0,6);
          try{
            const userDoc = await getDoc(doc(db,"users",uid));
            if(userDoc.exists()){
              const d = userDoc.data();
              displayName = d.name || d.delegateId || d.email || displayName;
            }
          }catch(_){}
          rows.push({ uid, displayName, count });
        }
        rows.sort((a,b)=>b.count - a.count);
        if(rows.length===0){ leaderListEl.innerHTML = '<div style="padding:8px 0;color:rgba(240,248,255,0.7)">No visits recorded yet.</div>'; return; }
        leaderListEl.innerHTML = '';
        rows.forEach((r,i)=>{
          const row = document.createElement('div');
          row.className = 'row';
          row.innerHTML = `<div style="font-weight:700">${i+1}. ${r.displayName}</div><div style="opacity:0.9">${r.count} stall${r.count===1?"":"s"}</div>`;
          leaderListEl.appendChild(row);
        });
      }catch(e){
        console.error("Leaderboard error",e);
        leaderListEl.innerHTML = '<div style="padding:8px 0;color:#ffdddd">Error loading leaderboard.</div>';
      }
    }

    window.manualRefreshLeaderboard = function(){
      loadLeaderboard().then(()=>showToast("Leaderboard refreshed"));
    };

    // initial build
    await buildGridFromFirestore();

    // call loadLeaderboard occasionally as extra safety (but only when visible)
    let leaderTimer = setInterval(()=>{ if(document.visibilityState==='visible') loadLeaderboard(); }, 15000);

  </script>
</body>
</html>
